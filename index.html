<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tanz Monitor 13.0</title>
    <style>
        :root { --blue: #007AFF; --red: #FF3B30; --green: #34C759; --yellow: #FFCC00; --bg: #000; }
        body { background: var(--bg); color: white; font-family: -apple-system, sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        #top-bar { padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; background: #111; border-bottom: 1px solid #333; }
        #monitor { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: space-around; text-align: center; padding: 20px; transition: 0.5s; }
        
        #song-tag { color: var(--yellow); font-size: 1.5rem; font-weight: bold; opacity: 0.8; }
        #dance-name { font-size: clamp(2rem, 12vw, 8rem); font-weight: 900; text-transform: uppercase; margin: 0; width: 100%; color: white; }
        
        /* SVG Bereich */
        #step-viz { height: 300px; width: 100%; display: flex; justify-content: center; align-items: center; position: relative; }
        .step-svg { max-height: 100%; width: auto; max-width: 100%; }

        /* NEU: CSS für die Walzer Animation */
        .step-circle { opacity: 0.2; transition: all 0.3s ease-out; }
        .step-circle.active { opacity: 1; filter: drop-shadow(0 0 15px currentColor); transform: scale(1.1); }
        .step-num { fill: white; font-size: 24px; font-weight: bold; pointer-events: none; }
        .red-step { color: var(--red); fill: var(--red); }
        .blue-step { color: var(--blue); fill: var(--blue); }

        #bpm-display { display: flex; align-items: baseline; gap: 15px; }
        #bpm-val { font-size: 7rem; font-weight: 900; font-family: monospace; color: var(--green); }
        .bpm-label { color: #444; letter-spacing: 5px; font-size: 1rem; }

        /* Settings Overlay */
        #settings { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.98); z-index: 1000; flex-direction: column; align-items: center; justify-content: center; 
        }
        .settings-box { width: 90%; max-width: 550px; background: #111; padding: 40px; border-radius: 30px; border: 1px solid #333; box-sizing: border-box; }
        .input-group { margin-bottom: 30px; }
        
        .label-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .label-text { font-size: 0.9rem; color: #888; text-transform: uppercase; letter-spacing: 2px; }
        .status-badge { color: var(--green); font-weight: bold; font-size: 0.9rem; display: none; }
        
        input { 
            width: 100%; padding: 20px; background: #1a1a1a; border: 2px solid #333; color: white; 
            border-radius: 15px; font-size: 1.2rem; box-sizing: border-box; 
        }
        input:focus { border-color: var(--blue); outline: none; }
        
        .btn { padding: 15px 30px; border-radius: 12px; font-weight: bold; cursor: pointer; border: none; font-size: 1.1rem; }
        .btn-blue { background: var(--blue); color: white; width: 100%; margin-top: 20px; }
        .btn-mic { background: var(--green); color: white; }
    </style>
</head>
<body>

<div id="top-bar">
    <div id="conn-status" style="font-size: 0.8rem; color: #555;">FUNK: BEREIT</div>
    <button class="btn btn-mic" id="start-btn" onclick="toggleMic()">START MONITOR</button>
    <button onclick="toggleSettings()" style="background:none; border:none; font-size:2.5rem; color:white;">⚙️</button>
</div>

<div id="monitor" style="opacity: 0.4;">
    <div id="song-tag">---</div>
    <h1 id="dance-name">BEREIT</h1>
    
    <div id="step-viz">
        </div>

    <div id="bpm-display">
        <div id="bpm-val">0</div>
        <div class="bpm-label">BPM</div>
    </div>
</div>

<div id="settings">
    <div class="settings-box">
        <h2 style="color:var(--blue); margin-top:0;">EINSTELLUNGEN</h2>
        
        <div class="input-group">
            <div class="label-row">
                <span class="label-text">OpenAI API Key</span>
                <span id="key-check" class="status-badge">✔ GESPEICHERT</span>
            </div>
            <input type="password" id="api-key" placeholder="Neuen Key eingeben..." autocomplete="off">
        </div>
        
        <div class="input-group">
            <div class="label-row">
                <span class="label-text">Funk-Kanalname</span>
                <span id="topic-check" class="status-badge">✔ VERBUNDEN</span>
            </div>
            <input type="text" id="topic-id" placeholder="Neuen Namen eingeben..." autocomplete="off">
        </div>

        <button class="btn btn-blue" onclick="saveSettings()">ÄNDERUNGEN SPEICHERN</button>
        <button onclick="toggleSettings()" style="background:none; border:none; color:#555; width:100%; margin-top:20px;">Abbrechen</button>
    </div>
</div>

<script>
    let audioCtx, analyser, processor, isRunning = false, lastB = 0, history = [], aiLock = false;
    let eventSource = null;
    
    // Variablen für die Walzer Animation
    let waltzTimer = null;
    let stepIndex = 1;

    // SVG Grafiken
    const steps = {
        // NEU: Animierter Walzer Box-Schritt mit Kreisen
        "walzer": `
        <svg class="step-svg" viewBox="0 0 400 400">
            <circle cx="130" cy="320" r="30" class="step-circle red-step" /><text x="122" y="330" class="step-num">L</text>
            <circle cx="270" cy="320" r="30" class="step-circle blue-step" /><text x="262" y="330" class="step-num">R</text>
            
            <circle id="s1" cx="270" cy="80" r="35" class="step-circle blue-step" /><text x="262" y="90" class="step-num">1</text>
            <circle id="s2" cx="130" cy="80" r="35" class="step-circle red-step" /><text x="122" y="90" class="step-num">2</text>
            <circle id="s3" cx="180" cy="130" r="35" class="step-circle blue-step" /><text x="172" y="140" class="step-num">3</text>
            
            <circle id="s4" cx="130" cy="320" r="35" class="step-circle red-step" /><text x="122" y="330" class="step-num">4</text>
            <circle id="s5" cx="270" cy="320" r="35" class="step-circle blue-step" /><text x="262" y="330" class="step-num">5</text>
            <circle id="s6" cx="220" cy="270" r="35" class="step-circle red-step" /><text x="212" y="280" class="step-num">6</text>
        </svg>`,
        "rumba": `<svg class="step-svg" viewBox="0 0 400 300"><rect x="100" y="50" width="200" height="200" fill="none" stroke="var(--green)" stroke-width="10"/><text x="60" y="160" fill="white" font-size="30">Slow</text><text x="280" y="40" fill="white" font-size="30">Quick</text><text x="280" y="280" fill="white" font-size="30">Quick</text></svg>`,
        "discofox": `<svg class="step-svg" viewBox="0 0 500 150"><circle cx="100" cy="75" r="30" fill="var(--blue)"/><circle cx="250" cy="75" r="30" fill="var(--blue)"/><circle cx="400" cy="75" r="15" fill="var(--red)"/><text x="90" y="140" fill="white">1</text><text x="240" y="140" fill="white">2</text><text x="385" y="140" fill="white">Tap</text></svg>`,
        "chacha": `<svg class="step-svg" viewBox="0 0 500 200"><path d="M50,100 L150,100 M250,100 L320,100 L400,100" stroke="white" stroke-width="15" stroke-linecap="round"/><text x="45" y="160" fill="white">1</text><text x="145" y="160" fill="white">2</text><text x="310" y="160" fill="white">3 & 4</text></svg>`
    };

    window.onload = () => {
        updateStatusBadges();
        const topic = localStorage.getItem('dm_topic');
        if (topic) connectToFunk(topic);
    };

    function updateStatusBadges() {
        document.getElementById('key-check').style.display = localStorage.getItem('dm_key') ? 'block' : 'none';
        document.getElementById('topic-check').style.display = localStorage.getItem('dm_topic') ? 'block' : 'none';
    }

    function toggleSettings() {
        const o = document.getElementById('settings');
        const isOpening = o.style.display !== 'flex';
        o.style.display = isOpening ? 'flex' : 'none';
        
        if (isOpening) {
            document.getElementById('api-key').value = "";
            document.getElementById('topic-id').value = "";
            updateStatusBadges();
        }
    }

    function saveSettings() {
        const key = document.getElementById('api-key').value.trim();
        const topic = document.getElementById('topic-id').value.trim();
        if (key) localStorage.setItem('dm_key', key);
        if (topic) localStorage.setItem('dm_topic', topic);
        toggleSettings();
        location.reload();
    }

    function connectToFunk(topic) {
        if (!topic) return;
        if (eventSource) eventSource.close();
        eventSource = new EventSource(`https://ntfy.sh/${topic}/sse`);
        eventSource.onopen = () => {
            document.getElementById('conn-status').innerText = "FUNK: AKTIV ✅";
            document.getElementById('conn-status').style.color = "var(--green)";
        };
        eventSource.onmessage = (e) => {
            const data = JSON.parse(e.data);
            if (data.message) triggerNewSong(data.message);
        };
    }

    function triggerNewSong(song) {
        document.getElementById('song-tag').innerText = song;
        document.getElementById('monitor').style.opacity = "1";
        aiLock = false;
        askAI(song);
    }

    async function askAI(song) {
        const key = localStorage.getItem('dm_key');
        if (!key) return;
        try {
            // Vorherige Animation stoppen
            clearWaltzAnimation();
            const resp = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${key}`},
                body: JSON.stringify({model: "gpt-4o-mini", messages: [{role: "user", content: `Lied: '${song}'. Welcher Tanz? Nur 1 Wort (z.B. Walzer, Rumba, Discofox).`}], max_tokens: 10})
            });
            const data = await resp.json();
            const dance = data.choices[0].message.content.trim().replace(".", "");
            document.getElementById('dance-name').innerText = dance;
            updateSteps(dance);
            aiLock = true;
        } catch (e) {}
    }

    function updateSteps(dance) {
        const d = dance.toLowerCase();
        let html = "";
        // Animation stoppen, falls sie läuft
        clearWaltzAnimation();

        if (d.includes("walzer")) {
            html = steps.walzer;
            document.getElementById('step-viz').innerHTML = html;
            // Starte Animation nach kurzem Delay damit SVG geladen ist
            setTimeout(startWaltzAnimation, 100);
        }
        else if (d.includes("rumba")) html = steps.rumba;
        else if (d.includes("disco")) html = steps.discofox;
        else if (d.includes("cha")) html = steps.chacha;
        
        if (!d.includes("walzer")) {
             document.getElementById('step-viz').innerHTML = html;
        }
    }

    // NEU: Animations-Logik für Walzer
    function startWaltzAnimation() {
        stepIndex = 1;
        // Sofort den ersten Schritt anzeigen
        animateWaltzStep();
        // Dann alle 700ms (ca. Walzer Tempo) weiterschalten
        waltzTimer = setInterval(animateWaltzStep, 700);
    }

    function animateWaltzStep() {
        // Alle Kreise zurücksetzen
        for(let i=1; i<=6; i++) {
            const el = document.getElementById('s'+i);
            if(el) el.classList.remove('active');
        }
        // Aktuellen Kreis aktivieren
        const current = document.getElementById('s'+stepIndex);
        if(current) current.classList.add('active');

        // Zähler erhöhen (1->6, dann wieder 1)
        stepIndex++;
        if(stepIndex > 6) stepIndex = 1;
    }

    function clearWaltzAnimation() {
        if (waltzTimer) {
            clearInterval(waltzTimer);
            waltzTimer = null;
        }
    }

    async function toggleMic() {
        if (isRunning) { location.reload(); return; }
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const source = audioCtx.createMediaStreamSource(stream);
        analyser = audioCtx.createAnalyser();
        processor = audioCtx.createScriptProcessor(2048, 1, 1);
        source.connect(analyser); analyser.connect(processor); processor.connect(audioCtx.destination);
        processor.onaudioprocess = (e) => {
            const data = e.inputBuffer.getChannelData(0);
            let sum = 0; for(let i=0; i<data.length; i++) sum += data[i]*data[i];
            const rms = Math.sqrt(sum / data.length);
            if (rms * 40 > 0.5) {
                const now = Date.now();
                if (now - lastB > 300) { handleBeat(now); lastB = now; }
            }
        };
        isRunning = true;
        document.getElementById('start-btn').innerText = "STOP";
        document.getElementById('start-btn').style.background = "var(--red)";
        document.getElementById('monitor').style.opacity = "1";
    }

    function handleBeat(now) {
        if (lastB > 0) {
            const interval = now - lastB;
            const bpm = Math.round(60000 / interval);
            history.push({t: now, v: bpm});
            history = history.filter(h => now - h.t < 10000);
            const avg = Math.round(history.reduce((a,b)=>a+b.v,0)/history.length);
            document.getElementById('bpm-val').innerText = avg;
        }
    }
</script>
</body>
</html>
