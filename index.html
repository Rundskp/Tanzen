<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <title>Tanz das! Ultimate</title>
    <link rel="icon" type="image/svg+xml" href="icon.svg">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">

    <style>
        :root { --blue: #2b7cff; --red: #FF3B30; --green: #34C759; --yellow: #FFCC00; --bg: #050505; --card: #1c1c1e; --text: #e8e8e8; --muted: #9aa0a6; }
        
        * { box-sizing: border-box; touch-action: manipulation; user-select: none; -webkit-user-select: none; }
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; background: var(--bg); color: var(--text); font-family: system-ui, -apple-system, sans-serif; }
        body { display: flex; flex-direction: column; }
        
        /* HEADER - H√ñCHSTER Z-INDEX DAMIT KLICKBAR */
        #top-bar { 
            display: grid; grid-template-columns: 60px 1fr 120px; align-items: center; 
            padding: 10px 15px; background: rgba(20,20,20,0.95); border-bottom: 1px solid #333; 
            z-index: 9999; flex-shrink: 0; position: relative;
        }
        .header-icon-btn { background: none; border: none; font-size: 1.6rem; cursor: pointer; color: var(--text); padding: 5px; }
        
        #mic-btn { background: #333; border: 2px solid #444; color: white; padding: 10px 10px; border-radius: 12px; font-weight: 900; font-size: 0.9rem; cursor: pointer; justify-self: center; width: 110px; transition: 0.2s; }
        #mic-btn.active { background: var(--green); border-color: var(--green); box-shadow: 0 0 15px rgba(52, 199, 89, 0.4); }
        #mic-btn.ai-mode { background: var(--blue); border-color: var(--blue); box-shadow: 0 0 15px rgba(43, 124, 255, 0.4); }
        #mic-btn.loading { opacity: 0.7; animation: pulse-load 1s infinite; }
        @keyframes pulse-load { 50% { opacity: 0.3; } }

        /* MONITOR */
        #monitor { flex: 1; display: flex; position: relative; width: 100%; overflow: hidden; flex-direction: column; z-index: 1; }
        #vis-wrap { width: 100%; height: 80px; position: relative; border-bottom: 1px solid #222; background: #000; flex-shrink: 0; }
        #visualizer { width: 100%; height: 100%; display: block; }

        #main-display { 
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: space-evenly; 
            padding: 10px; width: 100%; padding-right: 60px; z-index: 2; 
        }

        #song-info { width: 100%; min-height: 80px; display: flex; flex-direction: column; align-items: center; justify-content: center; margin-bottom: 5px; transition: opacity 0.5s; opacity: 0; text-align: center; }
        #song-title { font-size: 1.4rem; color: var(--yellow); font-weight: 800; text-shadow: 0 0 10px rgba(255,204,0,0.3); max-width: 95%; line-height: 1.1; margin-bottom: 4px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        #song-artist { font-size: 1rem; color: #bbb; font-weight: 500; max-width: 90%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        #ai-details { font-size: 0.8rem; color: #aaa; margin-top: 8px; display: flex; gap: 6px; }
        .detail-badge { background: #333; padding: 3px 8px; border-radius: 6px; border: 1px solid #444; font-weight: bold; letter-spacing: 0.5px; }

        .dance-wrap { position: relative; width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; flex: 1; min-height: 150px; }
        #dance-name { font-size: clamp(2.5rem, 11vw, 5rem); font-weight: 900; text-transform: uppercase; margin: 0; line-height: 0.9; color: #fff; text-align: center; }
        #dance-name.verified { color: var(--green); text-shadow: 0 0 25px rgba(52, 199, 89, 0.6); }
        .pulse-effect { animation: pump 0.15s ease-out; }
        @keyframes pump { 0% { transform: scale(1); } 30% { transform: scale(1.1); text-shadow: 0 0 20px rgba(255,255,255,0.5); } 100% { transform: scale(1); } }

        .status-indicators { display: flex; gap: 15px; margin-top: 10px; align-items: flex-end; margin-bottom: 10px; width: 100%; justify-content: center; }
        .stat-box { display: flex; flex-direction: column; align-items: center; width: 80px; }
        .stat-val { font-size: 2.2rem; font-weight: 900; font-family: monospace; color: #555; line-height: 1; transition: color 0.2s; }
        .stat-val.active { color: #fff; }
        .stat-label { font-size: 0.6rem; letter-spacing: 1px; font-weight: bold; color: #555; margin-top: 5px; }

        /* Slider Sidebar */
        #slider-sidebar { 
            position: absolute; right: 0; top: 80px; bottom: 0; width: 50px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            border-left: 1px solid #333; background: rgba(0,0,0,0.5); z-index: 10; padding-bottom: 20px; 
        }
        .slider-wrap { flex: 1; position: relative; width: 100%; display: flex; justify-content: center; }
        input[type=range].vertical {
            writing-mode: vertical-lr; direction: rtl; width: 6px; height: 100%; 
            outline: none; background: transparent; cursor: pointer; z-index: 2;
        }
        #level-meter { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(52, 199, 89, 0.4); height: 0%; transition: height 0.05s; pointer-events: none; width: 100%; z-index: -1; }
        #sens-val-display { font-family: monospace; font-size: 0.75rem; margin-top: 10px; color: var(--blue); font-weight: bold; }

        /* OVERLAYS */
        .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 7000; flex-direction: column; padding: 20px; overflow-y: auto; }
        .overlay.active { display: flex; }
        .overlay-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-shrink: 0; }
        .overlay-title { font-size: 1.5rem; font-weight: 800; color: var(--blue); margin: 0; }
        .close-btn { background: #333; border: none; color: white; width: 35px; height: 35px; border-radius: 50%; font-weight: bold; cursor: pointer; }

        /* Settings CSS */
        .settings-group { background: var(--card); border-radius: 20px; padding: 20px; margin-bottom: 20px; border: 1px solid #333; }
        .row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 8px; }
        input[type="text"], input[type="password"], input[type="number"], select { background: #000; border: 1px solid #444; color: white; padding: 10px; border-radius: 8px; width: 100%; margin-top: 5px; }
        input[type="range"].horizontal { -webkit-appearance: none; width: 100%; height: 8px; background: #333; border-radius: 5px; outline: none; margin-top: 5px; }
        input[type="range"].horizontal::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 22px; height: 22px; background: var(--blue); border-radius: 50%; cursor: pointer; }
        input[type="checkbox"] { transform: scale(1.5); accent-color: var(--blue); }
        .btn-action { width: 100%; padding: 15px; border-radius: 12px; border: none; font-weight: 800; margin-top: 10px; cursor: pointer; font-size: 1rem; }
        .btn-save { background: var(--green); color: white; }
        .btn-secondary { background: #222; color: #fff; border: 1px solid #444; }
        .btn-test-small { background: #444; border: 1px solid #666; color: white; padding: 5px 15px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 0.75rem; margin-left: 10px; }

        /* Donate */
        .ctaGrid { display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top: 15px; }
        @media (max-width:600px){ .ctaGrid{ grid-template-columns: 1fr; } }
        .payCard { background: rgba(255,255,255,.05); border-radius: 12px; padding: 15px; border: 1px solid #333; }
        .payCardHeading { font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; color: var(--muted); font-weight: bold; }
        .payBtnBig { display:block; width: 100%; border-radius: 8px; overflow:hidden; border:1px solid rgba(255,255,255,.10); margin-bottom: 10px; }
        .paypalImg { width:100%; height:auto; display:block; }
        .addrBox { background: rgba(0,0,0,.2); padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,.1); font-family: monospace; font-size: 0.85rem; word-break: break-all; margin-bottom: 10px; color: #ccc; }
        .qrImg { width: 100%; height: auto; border-radius: 8px; border:1px solid rgba(255,255,255,.10); margin-top: 10px; display:none; }
        .donate-text { font-size: 0.9rem; color: #aaa; line-height: 1.5; margin-bottom: 0; }
        .btn-donate-small { background: #333; color: #fff; border: 1px solid #444; padding: 8px 12px; border-radius: 6px; font-size: 0.8rem; font-weight: bold; cursor: pointer; flex:1; }
        .donate-actions { display: flex; gap: 10px; }

        /* Lists */
        #pref-list { display: flex; flex-wrap: wrap; gap: 8px; margin: 10px 0; }
        .tag { background: var(--blue); color: white; padding: 6px 12px; border-radius: 15px; font-size: 0.85rem; display: flex; align-items: center; }
        .tag span { margin-left: 8px; cursor: pointer; font-weight: bold; opacity: 0.7; }
        #history-list { display: flex; flex-direction: column; gap: 15px; padding-bottom: 40px; }
        .hist-card { background: #151515; border: 1px solid #333; border-radius: 16px; padding: 15px; display: flex; flex-direction: column; gap: 6px; position: relative; }
        .hist-del { position: absolute; top: 10px; right: 10px; color: #555; font-weight: bold; padding: 10px; cursor: pointer; }
        .hist-title { font-size: 1.2rem; font-weight: 800; color: #fff; padding-right: 30px; line-height: 1.2; }
        .hist-artist { font-size: 1rem; color: #aaa; font-weight: 500; }
        .hist-info { display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; color: var(--blue); font-weight: 700; margin-top: 5px; }
        .hist-stars { display: flex; justify-content: center; gap: 10px; background: #080808; padding: 10px; border-radius: 10px; margin-top: 8px; border-top: 1px solid #222; }
        .star-btn { font-size: 1.6rem; color: #333; cursor: pointer; transition: 0.1s; }
        .star-btn.active { color: var(--yellow); text-shadow: 0 0 10px rgba(255, 204, 0, 0.4); }

        .expert-row { display: grid; grid-template-columns: 1.5fr 0.8fr 0.8fr 1.2fr; gap: 8px; margin-bottom: 8px; align-items: center; font-size: 0.8rem; }
        .expert-row input { text-align: center; padding: 8px; font-size: 0.8rem; }
        .expert-header { font-weight: bold; color: #888; margin-bottom: 10px; }

        /* Video */
        .figure-list { display: flex; flex-direction: column; gap: 15px; margin-top: 15px; }
        .figure-item { background: #222; padding: 20px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border: 1px solid #333; font-size: 1.1rem; min-height: 60px; }
        .figure-play { color: var(--green); font-size: 1.8rem; }
        .dance-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .dance-card { background: var(--card); padding: 15px; border-radius: 15px; text-align: center; border: 1px solid #333; cursor: pointer; transition: 0.2s; }
        .dance-card:active { transform: scale(0.95); background: var(--blue); border-color: var(--blue); }

        #fs-video-overlay { background: black; display: none; flex-direction: column; justify-content: center; align-items: center; padding: 0; z-index: 7000; }
        #fs-video-overlay.active { display: flex; }
        #fs-video-container { width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; padding-bottom: 20px; position: relative; }
        #vid-info { color: var(--yellow); font-size: 1.2rem; font-weight: bold; text-align: center; margin-bottom: 10px; padding: 0 20px; z-index: 5; }
        #main-video { max-width: 100%; max-height: 75vh; width: auto; height: auto; object-fit: contain; background: #000; }
        #fs-controls { margin-top: 15px; display: flex; gap: 15px; justify-content: center; width: 100%; align-items: center; }
        .vid-btn { background: rgba(255,255,255,0.15); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 30px; padding: 12px 25px; cursor: pointer; backdrop-filter: blur(5px); font-weight: bold; min-width: 100px; }
        .nav-btn { background: #333; color: white; border: 1px solid #555; border-radius: 50%; width: 50px; height: 50px; font-size: 1.5rem; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .nav-btn:active { background: var(--blue); }
        
        @media (orientation: landscape) {
            #fs-video-container { flex-direction: row; flex-wrap: wrap; }
            #vid-info { width: 100%; position: absolute; top: 10px; background: rgba(0,0,0,0.5); padding: 5px; }
            #main-video { max-height: 85vh; width: auto; margin-bottom: 40px; }
            #fs-controls { position: absolute; bottom: 10px; }
        }

        /* Tap Detector 5.0 - PRO */
        #tap-pad { flex: 1; display: flex; flex-direction: column; gap: 20px; align-items: center; justify-content: center; }
        .tap-area { 
            width: 220px; height: 220px; 
            background: radial-gradient(circle, #333 0%, #111 100%); 
            border: 4px solid #444; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 4rem; transition: 0.05s; cursor: pointer; 
            touch-action: manipulation; color: #666; user-select: none; 
            -webkit-tap-highlight-color: transparent;
        }
        .tap-area.active { transform: scale(0.92); border-color: var(--blue); background: var(--blue); color: white; box-shadow: 0 0 30px var(--blue); }
        #tap-status { font-size: 1rem; color: #aaa; min-height: 20px; text-align:center; margin-top:10px; }
        #tap-result { font-size: 2.5rem; font-weight: 900; color: var(--yellow); margin-top: 15px; text-shadow: 0 0 15px rgba(255, 204, 0, 0.4); min-height: 50px; text-align: center; }
        .tap-viz-container { display: flex; gap: 6px; margin-top: 10px; height: 20px; align-items: center; }
        .tap-viz-dot { width: 10px; height: 10px; background: #333; border-radius: 50%; transition: 0.2s; }
        .tap-viz-dot.accent { background: var(--red); box-shadow: 0 0 8px var(--red); transform: scale(1.3); }
        .tap-viz-dot.normal { background: var(--green); box-shadow: 0 0 5px var(--green); }
    </style>
</head>
<body>

<div id="top-bar">
    <button class="header-icon-btn" onclick="openOverlay('settings-overlay')">‚öôÔ∏è</button>
    <button id="mic-btn" onclick="mainAction()">START</button>
    <div style="display:flex; justify-content: flex-end; gap: 15px;">
        <button class="header-icon-btn" onclick="openOverlay('donate-overlay')">‚òïÔ∏è</button>
        <button class="header-icon-btn" onclick="openOverlay('tap-overlay')">üñêÔ∏è</button>
        <button class="header-icon-btn" onclick="openOverlay('library-overlay')">?</button>
    </div>
</div>

<div id="monitor">
    <div id="vis-wrap"><canvas id="visualizer"></canvas></div>
    <div id="main-display">
        <div id="song-info">
            <div id="song-title">Warte auf Musik...</div>
            <div id="song-artist"></div>
            <div id="ai-details">
                <span class="detail-badge" id="badge-source">LOKAL</span>
                <span class="detail-badge" id="badge-rhythm"></span>
            </div>
        </div>
        <div class="dance-wrap">
            <h1 id="dance-name">BEREIT</h1>
        </div>
        <div class="status-indicators">
            <div class="stat-box"><div id="bpm-display" class="stat-val">0</div><div class="stat-label">BPM</div></div>
            <div class="stat-box"><div id="takt-display" class="stat-val">--</div><div class="stat-label">TAKT</div></div>
            <div class="stat-box"><div id="density-display" class="stat-val" style="font-size:1.5rem; color:#888;">0.0</div><div class="stat-label">DICHTE</div></div>
        </div>
    </div>
    <div id="slider-sidebar">
        <div class="slider-wrap">
            <div id="level-meter"></div>
            <input type="range" class="vertical" id="main-sens" min="1" max="100" value="45" oninput="updateSens(this.value)">
        </div>
        <div id="sens-val-display">45</div>
    </div>
</div>

<div id="settings-overlay" class="overlay">
    <div class="overlay-header"><h2 class="overlay-title">Einstellungen</h2><button class="close-btn" onclick="closeOverlays()">‚úï</button></div>
    <div class="settings-group">
        <div class="row">
            <label>KI Modell</label>
            <select id="ai-provider" style="width:65%;" onchange="handleProviderChange()">
                <option value="openai">OpenAI (GPT-5.2)</option>
                <option value="gemini">Google Gemini (3.0 Flash Preview)</option>
            </select>
        </div>
        <div class="row"><label>API Key</label><div style="display:flex; gap:10px; width:65%;"><input type="password" id="api-key" placeholder="Key hier einf√ºgen..."><button class="btn-test-small" onclick="testAI()">TEST</button></div></div>
        <div class="row"><label>Funk-Topic (Shazam)</label><div style="display:flex; gap:10px; width:65%;"><input type="text" id="ntfy-topic" placeholder="Topic..."><button class="btn-test-small" onclick="testFunk()">TEST</button></div></div>
        <div class="row" style="margin-top:15px;"><label>Disco-Modus</label><input type="checkbox" id="disco-mode"></div>
        <div class="row"><label>Video Ton</label><input type="checkbox" id="video-audio"></div>
        <div class="row"><label>Video Speed</label><div style="width: 50%;"><input type="range" class="horizontal" id="video-speed" min="0.25" max="1.0" step="0.25" value="1.0" oninput="updateSpeedLabel(this.value)"><div id="speed-val" style="text-align:right; font-size:0.8rem; color:var(--blue);">1.0x</div></div></div>
        <button class="btn-action btn-secondary" style="margin-top:20px;" onclick="openOverlay('expert-overlay')">Experten & BPM</button>
        <button class="btn-action btn-save" onclick="saveSettings()">Speichern</button>
    </div>
    <div class="settings-group">
        <div class="row"><label>Bevorzugte T√§nze</label></div>
        <div id="pref-list"></div>
        <div style="display:flex; gap:10px; margin-top:10px;"><input type="text" id="new-pref" placeholder="Neuer Tanz..."><button class="btn-save" style="width:auto; padding:0 20px;" onclick="addPref()">+</button></div>
    </div>
    <div class="settings-group">
        <div class="row"><label>Datenbank</label><input type="text" id="search-hist" placeholder="Suche..." style="width:40%;" oninput="renderHistory()"></div>
        <div id="history-list"></div>
        <div style="display:flex; gap:10px; margin-top:20px;"><button class="btn-action btn-secondary" onclick="exportData()">Export</button><button class="btn-action btn-secondary" onclick="document.getElementById('file-imp').click()">Import</button><input type="file" id="file-imp" style="display:none" onchange="importData(this)"></div>
    </div>
</div>

<div id="donate-overlay" class="overlay">
    <div class="overlay-header"><h2 class="overlay-title">‚òïÔ∏è Spenden</h2><button class="close-btn" onclick="closeOverlays()">‚úï</button></div>
    <div class="settings-group">
        <p class="donate-text">Support via PayPal oder Bitcoin. ‚ù§Ô∏è</p>
        <div class="ctaGrid">
            <div class="payCard">
                <div class="payCardHeading">PayPal</div>
                <a class="payBtnBig" href="https://paypal.me/rophko" target="_blank" rel="noopener"><img class="paypalImg" alt="PayPal" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='420' height='140' viewBox='0 0 420 140'><rect width='420' height='140' rx='24' fill='%23f5f7ff'/><text x='50%25' y='55%25' text-anchor='middle' font-family='Arial' font-size='44' fill='%23003087'>PayPal</text><text x='50%25' y='80%25' text-anchor='middle' font-family='Arial' font-size='20' fill='%23003087'>Jetzt spenden</text></svg>"/></a>
                <div class="donate-actions"><button id="btnPaypalQR" type="button" class="btn-donate-small">QR anzeigen</button></div>
                <img id="paypalQrImg" class="qrImg" alt="PayPal QR" />
            </div>
            <div class="payCard">
                <div class="payCardHeading">Bitcoin</div>
                <div class="addrBox" id="btcAddr">bc1qwr08y9ngmvplpr8tuk4w34rl4pkryur8u4cf5f</div>
                <div class="donate-actions"><button id="btnCopyBtc" type="button" class="btn-donate-small">Kopieren</button><button id="btnBtcQR" type="button" class="btn-donate-small">QR Code</button></div>
                <img id="btcQrImg" class="qrImg" alt="Bitcoin QR" />
            </div>
        </div>
    </div>
</div>

<div id="expert-overlay" class="overlay">
    <div class="overlay-header"><h2 class="overlay-title">Experten</h2><button class="close-btn" onclick="openOverlay('settings-overlay')">‚Üê</button></div>
    <div class="settings-group">
        <div style="margin-bottom:15px; text-align:right;"><button class="btn-action btn-secondary" onclick="resetExpert()" style="font-size:0.8rem;">Reset Standard</button></div>
        <div class="expert-row expert-header"><span>Tanz</span><span>Min</span><span>Max</span><span>Rhythmus</span></div>
        <div id="expert-list"></div>
        <button class="btn-action btn-save" onclick="saveSettings()">Werte Speichern</button>
    </div>
</div>

<div id="library-overlay" class="overlay">
    <div class="overlay-header"><h2 class="overlay-title">Videothek</h2><button class="close-btn" onclick="closeOverlays()">‚úï</button></div>
    <div id="library-content"></div>
</div>

<div id="fs-video-overlay" class="overlay">
    <div id="fs-video-container">
        <div id="vid-info">Titel</div>
        <video id="main-video" playsinline muted></video>
        <div id="fs-controls">
            <button class="nav-btn" onclick="prevFigure()">‚Üê</button>
            <button class="vid-btn" onclick="replayFigure()">‚Ü∫ Nochmal</button>
            <button class="vid-btn" onclick="closeOverlays(); document.getElementById('main-video').pause()">Schlie√üen</button>
            <button class="nav-btn" onclick="nextFigure()">‚Üí</button>
        </div>
    </div>
</div>

<div id="tap-overlay" class="overlay">
    <div class="overlay-header"><h2 class="overlay-title">Tap Detektor</h2><button class="close-btn" onclick="closeOverlays()">‚úï</button></div>
    <div style="text-align:center; color:#888; margin-bottom:20px;">
        Klopfe den Rhythmus. Langer Druck = Starker Schlag.<br>
        <span style="font-size:0.8rem; color:#666;">Analysiert ab 4 Taps kontinuierlich.</span>
    </div>
    <div id="tap-pad">
        <div class="tap-area" id="tapBtn" oncontextmenu="return false;">üñêÔ∏è</div>
        <div class="tap-viz-container" id="tap-viz"></div>
        <div id="tap-bpm" style="font-family:monospace; font-size:1.5rem; color:#666; margin-top:10px;">0 BPM</div>
        <div id="tap-result">...</div>
    </div>
    <button class="btn-action btn-secondary" onclick="resetTap()">Reset</button>
</div>

<script>
    // LEGAL & CONSOLE
    console.log(`%c Tanz das! Ultimate v2.9 `, "color: #2b7cff; font-weight: bold;");

    // --- CONSTANTS ---
    const DONATE = { paypal: "https://paypal.me/rophko", btc: "bc1qwr08y9ngmvplpr8tuk4w34rl4pkryur8u4cf5f" };

    // --- HELPER TO PREVENT CLICK BLOCK ---
    function openOverlay(id) {
        document.querySelectorAll('.overlay').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id === 'library-overlay') renderLibrary();
    }
    function closeOverlays() {
        document.querySelectorAll('.overlay').forEach(el => el.classList.remove('active'));
        const v = document.getElementById('main-video');
        if(!v.paused) v.pause();
    }

    // --- STATE ---
    let audioCtx, analyserLow, analyserHigh, isListening = false;
    let lastBeat = 0, aiLocked = false;
    let micSens = 0.04; 
    let discoEnabled = true, playbackSpeed = 1.0, videoSound = false;
    let aiProvider = "openai"; 
    let preferredDances = ["Walzer", "Rumba", "Cha Cha Cha", "Discofox", "Salsa", "Boogie", "Tango", "Foxtrott", "Quickstep"];
    let danceHistory = [];
    
    // Density Logic
    let densityLow = 0, densityHigh = 0;
    
    // Video
    let currentDance = "", currentFigIdx = 0;

    // --- VIDEO DATEN ---
    const videoLibrary = {
        "Cha Cha Cha": { file: "media/chacha.mp4", figures: [{ name: "1. Grundschritt", start: 0.00, end: 17.55 }, { name: "2. Wiegeschritt", start: 17.55, end: 30.48 }, { name: "3. Damensolo", start: 30.48, end: 52.88 }, { name: "4. New Yorker", start: 52.88, end: 80.30 }, { name: "5. Hand to Hand", start: 80.30, end: 103.50 }, { name: "6. Shoulder to Shoulder", start: 103.50, end: 123.37 }, { name: "7. Fan & Alemana", start: 123.37, end: 141.97 }, { name: "8. Hockeystick", start: 141.97, end: 169.44 }, { name: "9. Aida", start: 169.44, end: 197.17 }] },
        "Rumba": { file: "media/rumba.mp4", figures: [{ name: "1. Grundschritt", start: 0.00, end: 17.13 }, { name: "2. Damensolo", start: 17.13, end: 36.33 }, { name: "3. Hand to Hand", start: 36.33, end: 64.93 }, { name: "4. Shoulder to Shoulder", start: 64.93, end: 93.73 }, { name: "5. Fan & Alemana", start: 93.73, end: 115.33 }, { name: "6. Hockeystick", start: 115.33, end: 149.10 }, { name: "7. Aida", start: 149.10, end: 177.73 }] },
        "Discofox": { file: "media/discofox.mp4", figures: [{ name: "1. Grundschritt", start: 0.00, end: 16.00 }, { name: "2. Gelaufener GS", start: 16.00, end: 26.90 }, { name: "3. Brezel", start: 26.90, end: 63.60 }, { name: "4. K√∂rbchen", start: 63.60, end: 83.77 }, { name: "5. He goes, She goes", start: 83.77, end: 99.93 }, { name: "6. Travolta", start: 99.93, end: 119.90 }, { name: "7. Tunnel", start: 119.90, end: 138.80 }, { name: "8. Schiebet√ºr", start: 138.80, end: 160.07 }, { name: "9. Swing In/Out", start: 160.07, end: 180.03 }, { name: "10. Knochenbrecher", start: 180.03, end: 196.43 }] },
        "Jive": { file: "media/jive.mp4", figures: [{ name: "1. Grundschritt", start: 0.00, end: 12.03 }, { name: "2. Flirt", start: 12.03, end: 27.53 }, { name: "3. Platzwechsel", start: 27.53, end: 46.97 }, { name: "4. Stop'n'Go", start: 46.97, end: 64.03 }] },
        "Boogie Woogie": { file: "media/rock.mp4", figures: [{ name: "1. 6er GS", start: 0.00, end: 12.17 }, { name: "2. 9er GS", start: 12.17, end: 21.93 }, { name: "3. Platzwechsel", start: 21.93, end: 36.37 }, { name: "4. Swing In/Out", start: 36.37, end: 59.97 }, { name: "5. Flic Flac", start: 59.97, end: 90.63 }, { name: "6. Lasso", start: 90.63, end: 104.17 }, { name: "7. Handwechsel", start: 104.17, end: 116.90 }, { name: "8. American Spin", start: 116.90, end: 126.00 }, { name: "9. Tausendf√ºssler", start: 126.00, end: 143.83 }, { name: "10. Gr√§tsche", start: 143.83, end: 156.37 }] },
        "Samba": { file: "media/samba.mp4", figures: [{ name: "1. Grundschritt", start: 0.00, end: 25.10 }, { name: "2. Wischer", start: 25.10, end: 41.33 }, { name: "3. Damensolo", start: 41.33, end: 52.20 }, { name: "4. Promenaden", start: 52.20, end: 67.13 }, { name: "5. Side Walks", start: 67.13, end: 81.60 }, { name: "6. Botafogos", start: 81.60, end: 97.97 }] },
        "Walzer": { file: "", figures: [] }, "Langsamer Walzer": { file: "", figures: [] }, "Wiener Walzer": { file: "", figures: [] }, "Tango Argentino": { file: "", figures: [] }, "Foxtrott": { file: "", figures: [] }, "Salsa": { file: "", figures: [] }
    };

    const defaultRanges = {
        "Tango Argentino": { min: 55, max: 65, tact: "2/4", rhythm: "L L S" },
        "Langsamer Walzer": { min: 85, max: 95, tact: "3/4", rhythm: "L L L" },
        "Samba": { min: 100, max: 120, tact: "2/4", rhythm: "L S L" },
        "Rumba": { min: 100, max: 120, tact: "4/4", rhythm: "L S S" },
        "Discofox": { min: 100, max: 145, tact: "4/4", rhythm: "S S L" },
        "Cha Cha Cha": { min: 110, max: 135, tact: "4/4", rhythm: "S S S L L" },
        "Jive": { min: 130, max: 180, tact: "4/4", rhythm: "S S L S S L" },
        "Wiener Walzer": { min: 135, max: 180, tact: "3/4", rhythm: "L L L" },
        "Boogie Woogie": { min: 140, max: 200, tact: "4/4", rhythm: "S S L L" },
        "Foxtrott": { min: 160, max: 200, tact: "4/4", rhythm: "L L S S" },
        "Salsa": { min: 160, max: 200, tact: "4/4", rhythm: "S S L" }
    };
    let expertRanges = JSON.parse(JSON.stringify(defaultRanges));

    const canvas = document.getElementById('visualizer');
    const ctx = canvas.getContext('2d');
    
    // --- INIT ---
    window.onload = () => {
        loadData();
        // Load Provider Setting
        aiProvider = localStorage.getItem('dm_ai_provider') || 'openai';
        document.getElementById('ai-provider').value = aiProvider;
        loadKeyIntoInput(); // FIX: Lade korrekten Key

        const topic = localStorage.getItem('dm_topic');
        if(topic) { document.getElementById('ntfy-topic').value = topic; connectNtfy(topic); }
        
        discoEnabled = localStorage.getItem('dm_disco') !== 'false';
        document.getElementById('disco-mode').checked = discoEnabled;
        videoSound = localStorage.getItem('dm_vid_sound') === 'true';
        document.getElementById('video-audio').checked = videoSound;
        playbackSpeed = parseFloat(localStorage.getItem('dm_speed')) || 1.0;
        document.getElementById('video-speed').value = playbackSpeed;
        updateSpeedLabel(playbackSpeed);
        const savedSens = localStorage.getItem('dm_sens') || 45;
        updateSens(savedSens);
        
        renderPrefs(); renderHistory(); renderExpert();
        
        document.body.addEventListener('touchstart', function() {
            if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
        }, {once:true});

        // Initialize Tap Detector
        initTapDetector();

        // Donate Listener
        if(document.getElementById('btnPaypalQR')) {
            document.getElementById('btnPaypalQR').addEventListener("click", () => {
                const img = document.getElementById('paypalQrImg');
                img.style.display = (img.style.display === 'block') ? 'none' : 'block';
                if(img.style.display === 'block') img.src = "https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=" + encodeURIComponent(DONATE.paypal);
            });
            document.getElementById('btnBtcQR').addEventListener("click", () => {
                const img = document.getElementById('btcQrImg');
                img.style.display = (img.style.display === 'block') ? 'none' : 'block';
                if(img.style.display === 'block') img.src = "https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=" + encodeURIComponent("bitcoin:"+DONATE.btc);
            });
            document.getElementById('btnCopyBtc').addEventListener("click", () => {
                navigator.clipboard.writeText(DONATE.btc).then(() => alert("Adresse kopiert!"));
            });
        }
    };

    function loadKeyIntoInput() {
        const prov = document.getElementById('ai-provider').value;
        let val = "";
        if (prov === 'gemini') val = localStorage.getItem('dm_gemini_key') || "";
        else val = localStorage.getItem('dm_openai_key') || "";
        document.getElementById('api-key').value = val;
    }

    function handleProviderChange() { loadKeyIntoInput(); }

    function loadData() {
        if(localStorage.getItem('dm_prefs')) preferredDances = JSON.parse(localStorage.getItem('dm_prefs'));
        if(localStorage.getItem('dm_history')) danceHistory = JSON.parse(localStorage.getItem('dm_history'));
        if(localStorage.getItem('dm_expert')) expertRanges = JSON.parse(localStorage.getItem('dm_expert'));
    }

    /* --- AUDIO ENGINE --- */
    let bpmBuffer = [];
    
    function mainAction() {
        const btn = document.getElementById('mic-btn');
        if(btn.innerText === "START") toggleMic();
        else {
            isListening = false;
            if(audioCtx) audioCtx.suspend();
            btn.innerText = "START";
            btn.classList.remove('active', 'loading');
            document.getElementById('level-meter').style.height = "0%";
            bpmBuffer = []; lastBeat = 0; 
        }
    }

    async function toggleMic() {
        const btn = document.getElementById('mic-btn');
        btn.classList.add('loading');
        try {
            if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if(audioCtx.state === 'suspended') await audioCtx.resume();

            const stream = await navigator.mediaDevices.getUserMedia({ 
                audio: { echoCancellation: false, noiseSuppression: false, autoGainControl: false } 
            });
            const source = audioCtx.createMediaStreamSource(stream);
            
            const lowFilter = audioCtx.createBiquadFilter();
            lowFilter.type = "lowpass"; lowFilter.frequency.value = 120; 
            analyserLow = audioCtx.createAnalyser();
            analyserLow.fftSize = 512;
            source.connect(lowFilter);
            lowFilter.connect(analyserLow);

            const highFilter = audioCtx.createBiquadFilter();
            highFilter.type = "highpass"; highFilter.frequency.value = 2000;
            analyserHigh = audioCtx.createAnalyser();
            analyserHigh.fftSize = 512;
            source.connect(highFilter);
            highFilter.connect(analyserHigh);

            isListening = true;
            btn.innerText = "STOP";
            btn.classList.remove('loading', 'active');
            btn.classList.add('active');

            visualize();
            analyzeRhythm();
            setInterval(updateDensityUI, 3000); 

        } catch(e) { 
            alert("Mic Error: " + e.message); 
            btn.classList.remove('loading');
        }
    }

    function visualize() {
        if(!isListening) return;
        requestAnimationFrame(visualize);
        const bufferLen = analyserLow.frequencyBinCount;
        const lowData = new Uint8Array(bufferLen);
        const highData = new Uint8Array(bufferLen);
        analyserLow.getByteFrequencyData(lowData);
        analyserHigh.getByteFrequencyData(highData);
        
        ctx.fillStyle = '#000';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        let sumLow = 0;
        const barWidth = (canvas.width / bufferLen) * 2.5;
        let x = 0;
        for(let i = 0; i < bufferLen; i++) {
            sumLow += lowData[i];
            const barHeight = lowData[i] / 2;
            ctx.fillStyle = `rgb(${barHeight + 100},50,50)`;
            ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
            x += barWidth + 1;
        }
        const avgVol = sumLow / bufferLen;
        const volPercent = Math.min(100, (avgVol / 128) * 100); 
        document.getElementById('level-meter').style.height = volPercent + "%";

        x = 0;
        for(let i = 0; i < bufferLen; i++) {
            const barHeight = highData[i] / 2;
            ctx.fillStyle = `rgba(50,50,${barHeight + 100}, 0.5)`;
            ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
            x += barWidth + 1;
        }
    }

    function analyzeRhythm() {
        if(!isListening) return;
        setTimeout(analyzeRhythm, 20); 
        
        const lowData = new Uint8Array(analyserLow.frequencyBinCount);
        const highData = new Uint8Array(analyserHigh.frequencyBinCount);
        analyserLow.getByteFrequencyData(lowData);
        analyserHigh.getByteFrequencyData(highData);

        let sumL = 0; for(let i=0; i<lowData.length; i++) sumL += lowData[i];
        let sumH = 0; for(let i=0; i<highData.length; i++) sumH += highData[i];
        
        const avgL = sumL / lowData.length;
        const avgH = sumH / highData.length;
        const threshold = micSens * 255 * 0.8; 

        if(avgL > threshold) densityLow++;
        if(avgH > (threshold * 0.6)) densityHigh++;

        const now = Date.now();
        if(avgL > threshold && (now - lastBeat > 280)) { 
            processBeat(now);
            lastBeat = now;
        }
    }

    function updateDensityUI() {
        if(!isListening) return;
        let ratio = 0.0;
        if(densityLow > 0) ratio = (densityHigh / densityLow).toFixed(1);
        document.getElementById('density-display').innerText = ratio;
        densityLow = 0; densityHigh = 0;
    }

    function processBeat(now) {
        if(lastBeat > 0 && !aiLocked) {
            if(discoEnabled) {
                const el = document.getElementById('dance-name');
                el.classList.remove('pulse-effect');
                void el.offsetWidth;
                el.classList.add('pulse-effect');
            }
            const bpm = Math.round(60000 / (now - lastBeat));
            bpmBuffer.push(bpm);
            if(bpmBuffer.length > 8) bpmBuffer.shift();
            const avgBpm = Math.round(bpmBuffer.reduce((a,b)=>a+b,0) / bpmBuffer.length);
            document.getElementById('bpm-display').innerText = avgBpm;
            detectDance(avgBpm);
        }
    }

    function detectDance(bpm) {
        let matches = [];
        for(const [dance, range] of Object.entries(expertRanges)) {
            if(bpm >= range.min && bpm <= range.max) {
                matches.push({ name: dance, tact: range.tact, rhythm: range.rhythm });
            }
        }
        if(matches.length === 0) { updateDisplay("---", "--", "", false); return; }
        const preferredMatches = matches.filter(m => preferredDances.some(p => m.name.toLowerCase().includes(p.toLowerCase())));
        let winner = preferredMatches.length > 0 ? preferredMatches[0] : matches[0];
        if(preferredMatches.length > 1) {
            const nonDisco = preferredMatches.find(m => !m.name.toLowerCase().includes("disco"));
            if(nonDisco) winner = nonDisco;
        }
        updateDisplay(winner.name, winner.tact, winner.rhythm, false);
    }

    function updateDisplay(dance, tact, rhythm, verified) {
        document.getElementById('dance-name').innerText = dance;
        document.getElementById('takt-display').innerText = tact;
        document.getElementById('badge-rhythm').innerText = rhythm;
        const m = document.getElementById('dance-name');
        if(verified) m.classList.add('verified'); else m.classList.remove('verified');
        document.getElementById('badge-source').innerText = verified ? "KI / DB" : "LOKAL";
    }

    /* --- TAP LOGIC PRO (Rolling + Pressure) --- */
    let tapBuffer = [];
    let tapDownTime = 0;

    function initTapDetector() {
        const pad = document.getElementById('tapBtn');
        if(pad) {
            pad.addEventListener('pointerdown', tapDown);
            pad.addEventListener('pointerup', tapUp);
            pad.addEventListener('pointerleave', tapUp); // Handle drag out
        }
    }

    function tapDown(e) {
        e.preventDefault();
        const el = e.target;
        el.classList.add('active');
        tapDownTime = Date.now();
        // Check for 3D Touch (if available)
        if(e.pressure && e.pressure > 0.5) el.style.borderColor = 'var(--red)';
    }

    function tapUp(e) {
        e.preventDefault();
        const el = e.target;
        el.classList.remove('active');
        el.style.borderColor = '#444';
        
        const now = Date.now();
        const duration = now - tapDownTime;
        
        // PRESSURE CHECK
        let isHeavy = false;
        // 1. Hardware Pressure (Apple Pencil / 3D Touch legacy)
        if(e.pressure && e.pressure > 0.4) isHeavy = true;
        // 2. Fallback: Duration (Long Press = Heavy)
        else if(duration > 140) isHeavy = true;

        // Reset if pause too long (> 2.5s)
        if (tapBuffer.length > 0) {
            const lastTap = tapBuffer[tapBuffer.length - 1].time;
            if (now - lastTap > 2500) { resetTap(); tapBuffer = []; }
        }

        tapBuffer.push({ time: now, type: isHeavy ? "H" : "L" });
        // Rolling Buffer (Max 12)
        if(tapBuffer.length > 12) tapBuffer.shift();

        // Visualize
        const viz = document.getElementById('tap-viz');
        viz.innerHTML = tapBuffer.map(t => `<div class="tap-viz-dot ${t.type === 'H' ? 'accent' : 'normal'}"></div>`).join('');

        if(tapBuffer.length >= 4) {
            document.getElementById('tap-status').innerText = "Analysiere...";
            analyzeRollingTaps();
        } else {
            document.getElementById('tap-result').innerText = "...";
        }
    }

    function analyzeRollingTaps() {
        // BPM Calculation
        let intervals = [];
        for(let i=1; i<tapBuffer.length; i++) intervals.push(tapBuffer[i].time - tapBuffer[i-1].time);
        
        const avgMs = intervals.reduce((a,b)=>a+b,0) / intervals.length;
        const bpm = Math.round(60000/avgMs);
        document.getElementById('tap-bpm').innerText = bpm + " BPM";

        // Pattern: Interval based
        const minInterval = Math.min(...intervals);
        // "S" = Short interval, "L" = Long interval (~pause)
        // "H" = Heavy tap type
        const rhythmPattern = intervals.map((int, i) => {
            // Check interval length
            const isLong = int > minInterval * 1.45;
            // Check tap type of the START of the interval
            const type = tapBuffer[i].type; 
            return (isLong ? "L" : "S"); 
        }).join(""); 

        let matches = [];
        for(const [dance, data] of Object.entries(expertRanges)) {
            if (bpm >= data.min - 12 && bpm <= data.max + 12) { 
                const targetP = (data.rhythm || "").replace(/[^SL]/g, '');
                const userP = rhythmPattern.replace(/ /g, '');
                
                // Fuzzy Substring Match
                // Does User Pattern fit into Target? OR Target into User?
                if (targetP && (targetP.includes(userP) || userP.includes(targetP))) {
                    matches.push(dance);
                } else if (!targetP) {
                    matches.push(dance + "?"); // Match based on BPM only
                }
            }
        }

        const resEl = document.getElementById('tap-result');
        if(matches.length > 0) {
            const preferred = matches.filter(m => preferredDances.some(p => m.includes(p)));
            resEl.innerText = preferred.length > 0 ? preferred[0] : matches[0];
            resEl.style.color = preferred.length > 0 ? "var(--green)" : "var(--yellow)";
        } else {
            resEl.innerText = "???";
            resEl.style.color = "#666";
        }
    }

    function resetTap() {
        tapBuffer = [];
        document.getElementById('tap-bpm').innerText = "0 BPM";
        document.getElementById('tap-result').innerText = "---";
        document.getElementById('tap-viz').innerHTML = "";
        document.getElementById('tap-status').innerText = "Bereit";
    }

    /* --- EXTERNAL INPUT --- */
    function connectNtfy(topic) {
        const es = new EventSource(`https://ntfy.sh/${topic}/sse`);
        es.onmessage = (e) => {
            const d = JSON.parse(e.data);
            if(d.message) handleExternalInput(d.message);
        };
    }
    
    function cleanTitle(input) {
        if(!input) return "";
        try {
            if(typeof input === 'string' && (input.startsWith('{') || input.startsWith('"'))) {
                 const parsed = JSON.parse(input); return cleanTitle(parsed); 
            }
            if(typeof input === 'object') {
                if(input.body) return cleanTitle(input.body);
                if(input.message) return cleanTitle(input.message);
                if(input.title) return input.title;
            }
        } catch(e) {}
        return input;
    }

    function handleExternalInput(rawStr) {
        let clean = cleanTitle(rawStr);
        if(!clean || typeof clean !== 'string' || clean.includes("Test")) return;
        let artist = "Unbekannt", title = clean;
        if(clean.includes("-")) {
            const parts = clean.split("-");
            artist = parts[0].trim();
            title = parts.slice(1).join("-").trim();
        }
        document.getElementById('song-title').innerText = title;
        document.getElementById('song-artist').innerText = artist;
        document.getElementById('song-info').style.opacity = 1;
        const cached = danceHistory.find(x => x.title.toLowerCase().trim() === title.toLowerCase().trim());
        aiLocked = true; 
        if(cached) {
            updateDisplay(cached.dance, cached.tact || "4/4", cached.rhythm || "-", true);
            document.getElementById('bpm-display').innerText = cached.bpm || "DB";
            document.getElementById('badge-source').innerText = "DB";
        } else {
            askAI(artist, title);
        }
    }

    async function askAI(artist, title) {
        const key = document.getElementById('api-key').value.trim();
        const prov = document.getElementById('ai-provider').value;

        if(!key) { updateDisplay("KEY?", "--", "", false); return; }
        
        updateDisplay("KI DENKT...", "", "", false);
        document.getElementById('mic-btn').classList.add('ai-mode');
        
        const promptText = `Song: "${title}" by "${artist}". Pick best dance from: ${preferredDances.join(", ")}. Return ONLY JSON: {"dance": "Name", "bpm": number, "tact": "4/4", "rhythm": "string"}`;

        try {
            let data;
            
            if (prov === 'gemini') {
                // FIXED GEMINI MODEL
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key=${key}`;
                const res = await fetch(url, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: promptText }] }] })
                });
                const json = await res.json();
                if(json.error) throw new Error("Gemini: " + json.error.message);
                const rawText = json.candidates?.[0]?.content?.parts?.[0]?.text || "{}";
                const cleanJson = rawText.replace(/```json|```/g, '').trim();
                data = JSON.parse(cleanJson);
            } else {
                const res = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
                    body: JSON.stringify({ model: "gpt-5.2", messages: [{ role: "user", content: promptText }], max_tokens: 60 })
                });
                if(!res.ok) throw new Error("OpenAI: " + res.status);
                const json = await res.json();
                const raw = json.choices[0].message.content;
                const match = raw.match(/\{[\s\S]*\}/);
                if (!match) throw new Error("JSON Format Error");
                data = JSON.parse(match[0]);
            }

            danceHistory.unshift({
                date: new Date().toLocaleDateString('de-DE'),
                title: title, artist: artist,
                dance: data.dance, bpm: data.bpm,
                tact: data.tact, rhythm: data.rhythm, stars: 0
            });
            localStorage.setItem('dm_history', JSON.stringify(danceHistory));
            renderHistory();
            updateDisplay(data.dance, data.tact, data.rhythm, true);
            document.getElementById('bpm-display').innerText = data.bpm;

        } catch(e) {
            console.error(e);
            let msg = e.message.includes("401") ? "KEY FALSCH" : (e.message.includes("429") ? "LIMIT" : "NETZWERK/KI");
            updateDisplay(msg, "--", "!", false);
        }
        setTimeout(() => { document.getElementById('mic-btn').classList.remove('ai-mode'); }, 1000); 
    }

    async function testAI() {
        const k = document.getElementById('api-key').value.trim();
        const prov = document.getElementById('ai-provider').value;
        
        if(!k) return alert("Key fehlt!");
        
        try {
            if (prov === 'gemini') {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key=${k}`;
                const r = await fetch(url, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: "Hi" }] }] })
                });
                const d = await r.json();
                if(d.error) throw new Error(d.error.message);
            } else {
                const r = await fetch('https://api.openai.com/v1/chat/completions', {
                    method:'POST', 
                    headers:{'Content-Type': 'application/json', 'Authorization': `Bearer ${k}`}, 
                    body:JSON.stringify({model:"gpt-5.2", messages:[{role: "user", content: "Hi"}], max_tokens:5})
                });
                if(!r.ok) throw new Error("Status " + r.status);
            }
            alert("Verbindung OK! ‚úÖ");
        } catch(e) { alert("Fehler: " + e.message); }
    }
</script>
</body>
</html>
