<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Tanz das! Ultimate</title>
    <style>
        :root { --blue: #2b7cff; --red: #FF3B30; --green: #34C759; --yellow: #FFCC00; --bg: #050505; --card: #15161a; --text: #e8e8e8; }
        
        * { box-sizing: border-box; touch-action: manipulation; }
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; background: var(--bg); color: var(--text); font-family: system-ui, -apple-system, sans-serif; }
        body { display: flex; flex-direction: column; }
        
        /* Header */
        #top-bar { display: grid; grid-template-columns: 100px 1fr 140px; align-items: center; padding: 15px 20px; background: rgba(0,0,0,0.9); border-bottom: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(15px); flex-shrink: 0; }
        .header-btn { border: none; padding: 10px 0; border-radius: 10px; font-weight: 800; font-size: 0.75rem; cursor: pointer; transition: 0.3s; width: 85px; text-align: center; }
        .btn-off { background: rgba(255,255,255,0.05); color: #444; }
        .btn-on-local { background: var(--green); color: white; box-shadow: 0 0 15px rgba(52, 199, 89, 0.4); }
        .btn-on-ki { background: var(--blue); color: white; box-shadow: 0 0 15px rgba(43, 124, 255, 0.4); }
        #mic-btn { background: #222; border: 2px solid #333; color: white; padding: 12px 30px; border-radius: 16px; font-weight: 900; font-size: 1rem; cursor: pointer; justify-self: center; }
        .gear-btn { background: none; border: none; font-size: 2.2rem; cursor: pointer; padding: 5px; line-height: 1; color: var(--text); }

        /* Monitor */
        #monitor { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: space-evenly; text-align: center; padding: 10px; overflow-y: auto; }
        #song-info { min-height: 3rem; display: flex; flex-direction: column; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.5s ease; filter: drop-shadow(0 0 10px rgba(255,204,0,0.4)); }
        #song-title { font-size: 1.4rem; color: var(--yellow); font-weight: 900; }
        #song-artist { font-size: 1rem; color: #aaa; margin-top: 5px; }
        
        #takt-label { font-size: 1.3rem; color: var(--blue); font-weight: 800; letter-spacing: 5px; margin-top: 10px; }
        
        .dance-wrap { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; width: 100%; position: relative; }
        #dance-name { font-size: clamp(3rem, 14vw, 8rem); font-weight: 900; text-transform: uppercase; margin: 0; line-height: 0.9; z-index: 2; }
        .ai-badge { position: absolute; top: 10%; right: 10%; font-size: 3rem; display: none; filter: drop-shadow(0 0 15px var(--yellow)); z-index: 1; }
        
        .is-verified #dance-name { color: var(--yellow); }
        .is-verified .ai-badge { display: block; }

        @keyframes disco-pulse { 0% { transform: scale(1); } 50% { transform: scale(1.06); } 100% { transform: scale(1); } }
        .disco-active { animation: disco-pulse 0.4s infinite ease-in-out; }

        #bpm-display { margin-bottom: 5px; opacity: 0.5; transition: opacity 0.3s; }
        #bpm-val { font-size: 5rem; font-weight: 900; font-family: monospace; color: var(--green); line-height: 1; }
        .bpm-label { font-size: 1rem; letter-spacing: 8px; font-weight: bold; }

        /* Sensitivitäts Slider im Main Screen (nur sichtbar wenn Lokal an) */
        #sens-container { width: 80%; max-width: 300px; display: none; flex-direction: column; align-items: center; margin-bottom: 10px; }
        input[type=range] { width: 100%; -webkit-appearance: none; background: #333; height: 6px; border-radius: 3px; outline: none; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; background: var(--blue); border-radius: 50%; cursor: pointer; }

        /* Settings Overlay */
        #settings { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 4000; padding: 20px; overflow-y: auto; }
        .settings-card { background: var(--card); padding: 25px; border-radius: 25px; width: 100%; max-width: 800px; margin: auto; border: 1px solid #333; }
        
        .row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 12px; }
        .row label { font-size: 1rem; font-weight: bold; }
        
        .input-group { display: flex; align-items: center; gap: 10px; width: 60%; justify-content: flex-end; }
        input[type="text"], input[type="password"], input[type="number"] { background: #000; border: 1px solid #444; color: white; padding: 10px; border-radius: 8px; flex: 1; font-size: 1rem; }
        
        .btn-test { background: #333; border: none; color: white; padding: 8px 12px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 0.8rem; }
        
        /* Preferred Dances Tag Cloud */
        #pref-list { display: flex; flex-wrap: wrap; gap: 8px; margin: 10px 0; }
        .tag { background: var(--blue); color: white; padding: 8px 15px; border-radius: 20px; font-size: 0.9rem; display: flex; align-items: center; cursor: default; }
        .tag span { margin-left: 8px; cursor: pointer; font-weight: bold; opacity: 0.7; }
        .tag span:hover { opacity: 1; }
        .add-btn { background: var(--green); border: none; color: white; width: 40px; height: 40px; border-radius: 10px; font-size: 1.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        /* History Table */
        #history-box { background: #000; border-radius: 15px; padding: 10px; margin-top: 20px; border: 1px solid #222; max-height: 400px; overflow-y: auto; }
        .hist-header, .hist-row { display: grid; grid-template-columns: 80px 1.5fr 1.5fr 1fr 1fr 80px 30px; gap: 5px; align-items: center; padding: 8px; font-size: 0.8rem; }
        .hist-header { color: var(--blue); font-weight: bold; border-bottom: 1px solid #333; position: sticky; top: 0; background: #000; z-index: 10; }
        .hist-header div { cursor: pointer; user-select: none; }
        .hist-header div:hover { color: white; }
        .hist-row { border-bottom: 1px solid #111; }
        .hist-row:nth-child(even) { background: rgba(255,255,255,0.02); }
        .stars { cursor: pointer; letter-spacing: 1px; color: #333; font-size: 1.2rem; }
        .stars span.active { color: var(--yellow); }

        /* Expert Menu */
        .expert-toggle { width: 100%; text-align: left; background: #222; border: none; color: #aaa; padding: 15px; margin-top: 20px; border-radius: 10px; font-weight: bold; cursor: pointer; display: flex; justify-content: space-between; }
        #expert-panel { display: none; background: #111; padding: 15px; border-radius: 0 0 10px 10px; margin-top: -5px; border: 1px solid #333; border-top: none; }
        .expert-row { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 10px; margin-bottom: 8px; align-items: center; font-size: 0.9rem; }
        .expert-row input { text-align: center; }

        /* Mobile Optimierung */
        @media (max-width: 700px) {
            #top-bar { grid-template-columns: 80px 1fr 100px; padding: 10px; }
            .hist-header, .hist-row { grid-template-columns: 1.5fr 1fr 1fr 80px 30px; } /* Datum & Artist verstecken */
            .hist-header div:nth-child(1), .hist-row div:nth-child(1),
            .hist-header div:nth-child(3), .hist-row div:nth-child(3) { display: none; }
            #dance-name { font-size: 12vw; }
        }
    </style>
</head>
<body>

<div id="top-bar">
    <button id="btn-local" onclick="toggleLocal()" class="header-btn btn-off">LOKAL</button>
    <button id="mic-btn" onclick="mainAction()">START</button>
    <div style="display: flex; align-items: center; justify-content: flex-end;">
        <button id="btn-ki" class="header-btn btn-off" style="opacity: 0.5; cursor: default;">KI</button>
        <button onclick="toggleSettings()" class="gear-btn">⚙️</button>
    </div>
</div>

<div id="monitor">
    <div id="song-info">
        <div id="song-title"></div>
        <div id="song-artist"></div>
    </div>
    
    <div id="takt-label">ANALYSE...</div>
    
    <div class="dance-wrap">
        <h1 id="dance-name">BEREIT</h1>
        <div class="ai-badge">✨</div>
    </div>

    <div id="bpm-display">
        <div id="bpm-val">0</div>
        <div class="bpm-label">BPM LIVE</div>
    </div>
    
    <div id="sens-container">
        <label style="font-size: 0.7rem; color: #888; margin-bottom: 5px;">MIKRO-EMPFINDLICHKEIT</label>
        <input type="range" id="main-sens" min="1" max="100" value="45" oninput="updateSens(this.value)">
    </div>
</div>

<div id="settings">
    <div class="settings-card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="margin:0; color:var(--blue);">Einstellungen</h2>
            <button onclick="toggleSettings()" style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">✕</button>
        </div>

        <div class="row">
            <label>API Key (OpenAI)</label>
            <div class="input-group">
                <input type="password" id="api-key" placeholder="sk-...">
                <button class="btn-test" onclick="testAI()">TEST</button>
            </div>
        </div>
        
        <div class="row">
            <label>Funk-Topic (ntfy.sh)</label>
            <div class="input-group">
                <input type="text" id="topic-id" placeholder="Topic Name">
                <button class="btn-test" onclick="testFunk()">TEST</button>
            </div>
        </div>

        <div class="row">
            <label>Mikrofon-Sensitivität</label>
            <div class="input-group">
                <input type="range" id="set-sens" min="1" max="100" value="45" oninput="updateSens(this.value)">
                <span id="sens-val" style="width:30px; text-align:right;">45</span>
            </div>
        </div>

        <div style="margin-top:20px;">
            <label style="color:var(--blue); font-weight:bold;">Bevorzugte Tänze</label>
            <div style="font-size:0.8rem; color:#888; margin-bottom:10px;">Diese Tänze werden von der lokalen Erkennung und der KI priorisiert.</div>
            <div id="pref-list"></div>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <input type="text" id="new-pref" placeholder="Neuer Tanz..." style="flex:1;">
                <button class="add-btn" onclick="addPref()">+</button>
            </div>
        </div>

        <div style="margin-top:30px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <label style="color:var(--green); font-weight:bold;">Datenbank</label>
                <input type="text" id="hist-filter" placeholder="Suchen..." oninput="renderHistory()" style="width:150px; padding:5px;">
            </div>
            <div id="history-box">
                <div class="hist-header">
                    <div onclick="sortHist('date')">DATUM ↕</div>
                    <div onclick="sortHist('artist')">KÜNSTLER ↕</div>
                    <div onclick="sortHist('title')">TITEL ↕</div>
                    <div onclick="sortHist('dance')">TANZ ↕</div>
                    <div onclick="sortHist('stars')">⭐ ↕</div>
                    <div></div>
                </div>
                <div id="history-list"></div>
            </div>
            <div style="text-align:right; margin-top:5px; font-size:0.7rem; color:#666;">
                KI wird nur gefragt, wenn Titel nicht in DB.
            </div>
        </div>

        <button class="expert-toggle" onclick="toggleExpert()">
            <span>Experten-Werte (BPM Definitionen)</span>
            <span>▼</span>
        </button>
        <div id="expert-panel">
            <div style="margin-bottom:10px; text-align:right;">
                <button class="btn-test" onclick="resetExpert()">Auf Infografik zurücksetzen</button>
            </div>
            <div class="expert-row" style="color:#888; font-size:0.8rem;">
                <span>Tanz</span><span>Min BPM</span><span>Max BPM</span>
            </div>
            <div id="expert-list"></div>
        </div>

        <div style="margin-top:20px; text-align:center;">
            <button onclick="saveSettings()" style="background:var(--green); color:white; border:none; padding:15px 40px; border-radius:15px; font-weight:bold; font-size:1.1rem; cursor:pointer; width:100%;">SPEICHERN & SCHLIEßEN</button>
        </div>
    </div>
</div>

<script>
    /* --- CONFIG & STATE --- */
    let audioCtx, analyser, processor, isLocalRunning = false;
    let lastBeat = 0, bpmBuf = [], aiLocked = false;
    let micSens = 0.0045; // Internal value derived from slider (1-100)
    
    // Default from Infographic
    const defaultRanges = {
        "Tango Argentino": { min: 55, max: 65, tact: "2/4" },
        "Langsamer Walzer": { min: 85, max: 95, tact: "3/4" },
        "Samba": { min: 100, max: 120, tact: "2/4" },
        "Rumba": { min: 100, max: 120, tact: "4/4" }, // Infographic start
        "Discofox": { min: 100, max: 145, tact: "4/4" },
        "Cha Cha Cha": { min: 110, max: 135, tact: "4/4" },
        "Jive": { min: 130, max: 180, tact: "4/4" },
        "Wiener Walzer": { min: 135, max: 180, tact: "3/4" },
        "Boogie Woogie": { min: 140, max: 200, tact: "4/4" },
        "Foxtrott": { min: 160, max: 200, tact: "4/4" },
        "Salsa": { min: 160, max: 200, tact: "4/4" }
    };

    let expertRanges = JSON.parse(JSON.stringify(defaultRanges));
    // Pre-filled from Image
    let preferredDances = ["Walzer", "Rumba", "Cha Cha Cha", "Discofox", "Salsa", "Boogie", "Tango", "Foxtrott", "Quickstep"];
    let danceHistory = [];
    let sortKey = 'date', sortDir = -1;

    /* --- INITIALIZATION --- */
    window.onload = () => {
        loadData();
        renderPrefs();
        renderExpert();
        
        // Setup Inputs
        document.getElementById('api-key').value = localStorage.getItem('dm_key') || "";
        const topic = localStorage.getItem('dm_topic');
        if(topic) {
            document.getElementById('topic-id').value = topic;
            connectNtfy(topic);
        }
        
        // Sensitivity
        const savedSens = localStorage.getItem('dm_sens') || 45;
        updateSens(savedSens);
    };

    function loadData() {
        if(localStorage.getItem('dm_prefs')) preferredDances = JSON.parse(localStorage.getItem('dm_prefs'));
        if(localStorage.getItem('dm_history')) danceHistory = JSON.parse(localStorage.getItem('dm_history'));
        if(localStorage.getItem('dm_expert')) expertRanges = JSON.parse(localStorage.getItem('dm_expert'));
    }

    /* --- SETTINGS & UI --- */
    function toggleSettings() {
        const s = document.getElementById('settings');
        const isOpen = s.style.display === 'flex';
        s.style.display = isOpen ? 'none' : 'flex';
        if(!isOpen) renderHistory();
    }

    function saveSettings() {
        localStorage.setItem('dm_key', document.getElementById('api-key').value.trim());
        localStorage.setItem('dm_topic', document.getElementById('topic-id').value.trim());
        localStorage.setItem('dm_prefs', JSON.stringify(preferredDances));
        localStorage.setItem('dm_sens', document.getElementById('set-sens').value);
        
        // Save Expert Ranges
        const inputs = document.querySelectorAll('.expert-input');
        inputs.forEach(inp => {
            const dance = inp.dataset.dance;
            const type = inp.dataset.type;
            expertRanges[dance][type] = parseInt(inp.value);
        });
        localStorage.setItem('dm_expert', JSON.stringify(expertRanges));
        
        toggleSettings();
        location.reload(); // Reload to apply topic/mic changes cleanly
    }

    function updateSens(val) {
        document.getElementById('main-sens').value = val;
        document.getElementById('set-sens').value = val;
        document.getElementById('sens-val').innerText = val;
        micSens = val / 10000; // Map 1-100 to 0.0001 - 0.01
        localStorage.setItem('dm_sens', val);
    }

    /* --- PREFERRED DANCES --- */
    function renderPrefs() {
        const list = document.getElementById('pref-list');
        list.innerHTML = preferredDances.map((d,i) => 
            `<div class="tag">${d}<span onclick="preferredDances.splice(${i},1);renderPrefs()">✕</span></div>`
        ).join('');
    }
    function addPref() {
        const v = document.getElementById('new-pref').value.trim();
        if(v && !preferredDances.includes(v)) {
            preferredDances.push(v);
            document.getElementById('new-pref').value = "";
            renderPrefs();
        }
    }

    /* --- EXPERT MENU --- */
    function toggleExpert() {
        const p = document.getElementById('expert-panel');
        p.style.display = p.style.display === 'block' ? 'none' : 'block';
    }
    function renderExpert() {
        const el = document.getElementById('expert-list');
        el.innerHTML = Object.keys(expertRanges).map(d => `
            <div class="expert-row">
                <span>${d}</span>
                <input type="number" class="expert-input" data-dance="${d}" data-type="min" value="${expertRanges[d].min}">
                <input type="number" class="expert-input" data-dance="${d}" data-type="max" value="${expertRanges[d].max}">
            </div>
        `).join('');
    }
    function resetExpert() {
        if(confirm("Werte auf Infografik-Standard zurücksetzen?")) {
            expertRanges = JSON.parse(JSON.stringify(defaultRanges));
            renderExpert();
        }
    }

    /* --- AUDIO / LOCAL DETECTION --- */
    function mainAction() {
        const btn = document.getElementById('mic-btn');
        if(btn.innerText === "START") toggleLocal();
        else {
            isLocalRunning = false;
            if(audioCtx) audioCtx.close();
            btn.innerText = "START";
            document.getElementById('btn-local').className = "header-btn btn-off";
            document.getElementById('sens-container').style.display = "none";
        }
    }

    async function toggleLocal() {
        try {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const source = audioCtx.createMediaStreamSource(stream);
            analyser = audioCtx.createAnalyser();
            processor = audioCtx.createScriptProcessor(2048, 1, 1);
            
            source.connect(analyser);
            analyser.connect(processor);
            processor.connect(audioCtx.destination);

            isLocalRunning = true;
            document.getElementById('mic-btn').innerText = "STOP";
            document.getElementById('btn-local').className = "header-btn btn-on-local";
            document.getElementById('sens-container').style.display = "flex";
            
            processor.onaudioprocess = (e) => {
                if(!isLocalRunning) return;
                const data = e.inputBuffer.getChannelData(0);
                let sum = 0;
                for(let i=0; i<data.length; i++) sum += data[i]*data[i];
                const rms = Math.sqrt(sum/data.length);
                
                if(rms > micSens) {
                    const now = Date.now();
                    if(now - lastBeat > 300) { // Max 200 BPM
                        processBeat(now);
                        lastBeat = now;
                    }
                }
            };
        } catch(e) {
            alert("Mikrofon Zugriff verweigert!");
        }
    }

    function processBeat(now) {
        if(lastBeat > 0 && !aiLocked) {
            const bpm = Math.round(60000 / (now - lastBeat));
            bpmBuf.push(bpm);
            if(bpmBuf.length > 10) bpmBuf.shift();
            
            const avgBpm = Math.round(bpmBuf.reduce((a,b)=>a+b,0) / bpmBuf.length);
            document.getElementById('bpm-val').innerText = avgBpm;
            
            detectDance(avgBpm);
        }
    }

    function detectDance(bpm) {
        let matches = [];
        
        // Check ranges
        for(const [dance, range] of Object.entries(expertRanges)) {
            if(bpm >= range.min && bpm <= range.max) {
                matches.push({ name: dance, tact: range.tact });
            }
        }

        if(matches.length === 0) {
            updateDisplay("---", "4/4");
            return;
        }

        // Logic: Filter by Preferred first
        const preferredMatches = matches.filter(m => 
            preferredDances.some(p => m.name.toLowerCase().includes(p.toLowerCase()))
        );

        let winner = preferredMatches.length > 0 ? preferredMatches[0] : matches[0];
        
        // Special Case: Discofox overlaps almost everything.
        // If we have a preferred match that is NOT Discofox, prefer that over Discofox.
        if(preferredMatches.length > 1) {
            const nonDisco = preferredMatches.find(m => !m.name.toLowerCase().includes("disco"));
            if(nonDisco) winner = nonDisco;
        }

        updateDisplay(winner.name, winner.tact + " TAKT");
    }

    function updateDisplay(dance, tact, isVerified=false) {
        document.getElementById('dance-name').innerText = dance;
        document.getElementById('takt-label').innerText = tact || "";
        const m = document.getElementById('monitor');
        if(isVerified) m.classList.add('is-verified');
        else m.classList.remove('is-verified');
    }

    /* --- CLOUD / AI LOGIC --- */
    function connectNtfy(topic) {
        const es = new EventSource(`https://ntfy.sh/${topic}/sse`);
        es.onmessage = (e) => {
            const d = JSON.parse(e.data);
            if(d.message) handleExternalInput(d.message);
        };
    }

    function testFunk() {
        const t = document.getElementById('topic-id').value;
        fetch(`https://ntfy.sh/${t}`, { method:'POST', body:'Test Artist - Test Title' });
    }

    function handleExternalInput(rawStr) {
        if(rawStr.includes("Test")) return;
        
        // Parse Title/Artist (Assuming "Artist - Title" format from Shazam)
        let artist = "Unbekannt";
        let title = rawStr;
        if(rawStr.includes("-")) {
            const parts = rawStr.split("-");
            artist = parts[0].trim();
            title = parts.slice(1).join("-").trim();
        }

        document.getElementById('song-title').innerText = title;
        document.getElementById('song-artist').innerText = artist;
        document.getElementById('song-info').style.opacity = 1;

        // 1. Check DB (Cost Saving)
        const cached = danceHistory.find(x => 
            x.title.toLowerCase() === title.toLowerCase() && 
            x.artist.toLowerCase() === artist.toLowerCase()
        );

        aiLocked = true; // Stop local updates
        document.getElementById('bpm-display').style.opacity = 0.2;

        if(cached) {
            updateDisplay(cached.dance, "DB TREFFER", true);
            console.log("Aus Datenbank geladen");
        } else {
            askAI(artist, title);
        }
    }

    async function askAI(artist, title) {
        const key = document.getElementById('api-key').value;
        if(!key) { alert("Kein API Key!"); return; }

        updateDisplay("KI DENKT...", "", false);
        document.getElementById('btn-ki').className = "header-btn btn-on-ki";

        try {
            const prompt = `Song: "${title}" von "${artist}". 
            Wähle den besten Tanzstil aus dieser Liste (Priorität): ${preferredDances.join(", ")}. 
            Falls keiner passt, nimm einen Standard-Turniertanz.
            Antworte NUR mit dem Namen des Tanzes. Keine Erklärung.`;

            const res = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
                body: JSON.stringify({
                    model: "gpt-4o-mini",
                    messages: [{ role: "user", content: prompt }],
                    max_tokens: 10
                })
            });
            
            const data = await res.json();
            const dance = data.choices[0].message.content.replace(/[."]/g, "").trim();

            // Save to DB
            danceHistory.push({
                date: new Date().toLocaleDateString('de-DE'),
                title: title,
                artist: artist,
                dance: dance,
                stars: 0
            });
            localStorage.setItem('dm_history', JSON.stringify(danceHistory));
            
            updateDisplay(dance, "KI VERIFIZIERT", true);
        } catch(e) {
            updateDisplay("FEHLER", "", false);
        }
        
        // Reset after delay
        setTimeout(() => {
            document.getElementById('btn-ki').className = "header-btn btn-off";
            document.getElementById('song-info').style.opacity = 0;
            document.getElementById('bpm-display').style.opacity = 0.5;
            aiLocked = false;
        }, 15000);
    }
    
    async function testAI() {
        const key = document.getElementById('api-key').value;
        if(!key) return alert("Key fehlt!");
        try {
            await fetch('https://api.openai.com/v1/models', {headers:{'Authorization':`Bearer ${key}`}});
            alert("Verbindung OK!");
        } catch(e) { alert("Verbindung fehlgeschlagen"); }
    }

    /* --- HISTORY TABLE --- */
    function renderHistory() {
        const f = document.getElementById('hist-filter').value.toLowerCase();
        const list = document.getElementById('history-list');
        
        let filtered = danceHistory.filter(h => 
            h.title.toLowerCase().includes(f) || 
            h.artist.toLowerCase().includes(f) || 
            h.dance.toLowerCase().includes(f)
        );

        filtered.sort((a,b) => {
            let va = a[sortKey] || '', vb = b[sortKey] || '';
            if(sortKey === 'date') { // DE Date Sort fix
                va = va.split('.').reverse().join('');
                vb = vb.split('.').reverse().join('');
            }
            if(va < vb) return -1 * sortDir;
            if(va > vb) return 1 * sortDir;
            return 0;
        });

        list.innerHTML = filtered.map(h => {
            // Find true index in original array for editing
            const idx = danceHistory.indexOf(h);
            return `
            <div class="hist-row">
                <div>${h.date}</div>
                <div>${h.artist}</div>
                <div style="font-weight:bold; color:white;">${h.title}</div>
                <div style="color:var(--blue);">${h.dance}</div>
                <div class="stars">${renderStars(idx, h.stars)}</div>
                <div onclick="delHist(${idx})" style="color:var(--red); cursor:pointer; font-weight:bold; text-align:center;">✕</div>
            </div>`;
        }).join('');
    }

    function renderStars(idx, n) {
        let s = "";
        for(let i=1; i<=5; i++) s += `<span class="${i<=n?'active':''}" onclick="setStar(${idx},${i})">★</span>`;
        return s;
    }
    function setStar(idx, n) { danceHistory[idx].stars = n; localStorage.setItem('dm_history', JSON.stringify(danceHistory)); renderHistory(); }
    function delHist(idx) { 
        if(confirm("Eintrag löschen?")) {
            danceHistory.splice(idx,1); 
            localStorage.setItem('dm_history', JSON.stringify(danceHistory)); 
            renderHistory(); 
        }
    }
    function sortHist(key) {
        if(sortKey === key) sortDir *= -1;
        else { sortKey = key; sortDir = 1; }
        renderHistory();
    }
</script>
</body>
</html>