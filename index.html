<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Tanz das! Ultimate</title>
    <style>
        :root { --blue: #2b7cff; --red: #FF3B30; --green: #34C759; --yellow: #FFCC00; --bg: #050505; --card: #15161a; --text: #e8e8e8; }
        
        * { box-sizing: border-box; touch-action: manipulation; }
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; background: var(--bg); color: var(--text); font-family: system-ui, -apple-system, sans-serif; }
        body { display: flex; flex-direction: column; }
        
        /* --- HEADER --- */
        #top-bar { display: grid; grid-template-columns: 80px 1fr 80px; align-items: center; padding: 10px 15px; background: rgba(0,0,0,0.9); border-bottom: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(15px); z-index: 100; flex-shrink: 0; }
        .header-icon-btn { background: none; border: none; font-size: 1.8rem; cursor: pointer; color: var(--text); padding: 5px; }
        #mic-btn { background: #222; border: 2px solid #333; color: white; padding: 10px 20px; border-radius: 16px; font-weight: 900; font-size: 1rem; cursor: pointer; justify-self: center; width: 120px; transition: 0.3s; }
        #mic-btn.active { background: var(--red); box-shadow: 0 0 15px rgba(255, 59, 48, 0.4); border-color: var(--red); }
        #mic-btn.calibrated { background: var(--green); border-color: var(--green); box-shadow: 0 0 15px rgba(52, 199, 89, 0.4); }

        /* --- MONITOR BEREICH --- */
        #monitor { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: space-evenly; text-align: center; padding: 10px; overflow-y: auto; position: relative; }
        
        #song-info { width: 100%; min-height: 60px; display: flex; flex-direction: column; align-items: center; justify-content: center; margin-bottom: 10px; }
        #song-title { font-size: 1.4rem; color: var(--yellow); font-weight: 800; text-shadow: 0 0 10px rgba(255,204,0,0.3); opacity: 0; transition: opacity 0.5s; max-width: 90%; text-overflow: ellipsis; overflow: hidden; white-space: nowrap; }
        #ai-details { font-size: 0.8rem; color: #aaa; opacity: 0; transition: opacity 0.5s; display: flex; gap: 10px; margin-top: 5px; }
        .detail-badge { background: #333; padding: 2px 6px; border-radius: 4px; border: 1px solid #444; }

        .dance-wrap { position: relative; width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; flex: 1; min-height: 150px; }
        #dance-name { font-size: clamp(2.5rem, 12vw, 6rem); font-weight: 900; text-transform: uppercase; margin: 0; line-height: 0.9; color: #fff; transition: color 0.3s; }
        #dance-name.verified { color: var(--green); text-shadow: 0 0 20px rgba(52, 199, 89, 0.5); }
        
        .status-indicators { display: flex; gap: 15px; margin-top: 20px; align-items: flex-end; }
        .stat-box { display: flex; flex-direction: column; align-items: center; }
        .stat-val { font-size: 3rem; font-weight: 900; font-family: monospace; color: #666; line-height: 1; transition: color 0.2s; }
        .stat-label { font-size: 0.7rem; letter-spacing: 2px; font-weight: bold; color: #555; margin-top: 5px; }
        .active-stat { color: var(--blue); }

        /* Video Container (Mini Player) */
        #mini-video-player { position: absolute; bottom: 20px; right: 20px; width: 120px; height: 180px; background: #000; border: 2px solid #333; border-radius: 12px; display: none; overflow: hidden; z-index: 50; box-shadow: 0 5px 20px rgba(0,0,0,0.5); cursor: pointer; }
        #mini-video-player video { width: 100%; height: 100%; object-fit: cover; }
        
        /* --- OVERLAYS (Settings, Library, Tap, Video) --- */
        .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000; flex-direction: column; padding: 20px; overflow-y: auto; }
        .overlay.active { display: flex; }
        .overlay-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .overlay-title { font-size: 1.5rem; font-weight: 800; color: var(--blue); margin: 0; }
        .close-btn { background: #333; border: none; color: white; width: 35px; height: 35px; border-radius: 50%; font-weight: bold; cursor: pointer; }

        /* Settings CSS */
        .settings-group { background: var(--card); border-radius: 20px; padding: 20px; margin-bottom: 20px; border: 1px solid #333; }
        .row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 8px; }
        .row:last-child { border-bottom: none; margin-bottom: 0; }
        input[type="text"], input[type="password"] { background: #000; border: 1px solid #444; color: white; padding: 10px; border-radius: 8px; width: 100%; margin-top: 5px; }
        .btn-action { width: 100%; padding: 15px; border-radius: 12px; border: none; font-weight: 800; margin-top: 10px; cursor: pointer; font-size: 1rem; }
        .btn-save { background: var(--green); color: white; }
        .btn-danger { background: #333; color: var(--red); border: 1px solid var(--red); }
        .btn-secondary { background: #222; color: #fff; border: 1px solid #444; }

        /* Video Library CSS */
        .dance-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .dance-card { background: var(--card); padding: 15px; border-radius: 15px; text-align: center; border: 1px solid #333; cursor: pointer; transition: 0.2s; }
        .dance-card:active { transform: scale(0.95); background: var(--blue); border-color: var(--blue); }
        .figure-list { display: flex; flex-direction: column; gap: 10px; }
        .figure-item { background: #222; padding: 15px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border: 1px solid #333; }
        .figure-item:hover { background: #333; }
        .figure-play { color: var(--green); font-size: 1.5rem; }

        /* Fullscreen Video Overlay */
        #fs-video-overlay { background: black; justify-content: center; align-items: center; padding: 0; }
        #fs-video-container { width: 100%; max-width: 1000px; position: relative; }
        #main-video { width: 100%; border-radius: 10px; }
        #fs-controls { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 20px; }
        .vid-btn { background: rgba(0,0,0,0.6); color: white; border: 1px solid white; border-radius: 30px; padding: 10px 20px; cursor: pointer; backdrop-filter: blur(5px); }

        /* Tap Detector */
        #tap-pad { flex: 1; display: flex; flex-direction: column; gap: 20px; align-items: center; justify-content: center; }
        .tap-area { width: 200px; height: 200px; background: radial-gradient(circle, #333 0%, #111 100%); border: 4px solid #444; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 3rem; user-select: none; transition: 0.1s; cursor: pointer; }
        .tap-area:active { transform: scale(0.95); border-color: var(--blue); background: var(--blue); color: white; box-shadow: 0 0 30px var(--blue); }
        #tap-result { font-size: 2rem; color: var(--yellow); font-weight: 800; min-height: 3rem; }

        /* History Table */
        #history-list { display: flex; flex-direction: column; gap: 10px; padding-bottom: 50px; }
        .hist-card { background: #111; border: 1px solid #333; border-radius: 12px; padding: 12px; display: grid; grid-template-columns: 1fr auto; gap: 8px; }
        .hist-top { grid-column: 1 / -1; display: flex; justify-content: space-between; font-size: 0.8rem; color: #777; border-bottom: 1px solid #222; padding-bottom: 5px; margin-bottom: 5px; }
        .hist-title { font-weight: bold; color: #eee; grid-column: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .hist-dance { color: var(--blue); font-weight: 800; grid-column: 1; }
        .hist-meta { grid-column: 1; font-size: 0.8rem; color: #999; display: flex; gap: 10px; }
        .hist-stars { grid-column: 2; grid-row: 2 / span 2; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 1.2rem; color: #444; }
        .hist-stars .active { color: var(--yellow); }
        .hist-del { grid-column: 2; grid-row: 1; color: var(--red); justify-self: end; cursor: pointer; }

        /* Disco Animation */
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .disco-beat { animation: pulse 0.15s ease-out; }
    </style>
</head>
<body>

<div id="top-bar">
    <button class="header-icon-btn" onclick="openOverlay('settings-overlay')">‚öôÔ∏è</button>
    <button id="mic-btn" onclick="toggleMic()">START</button>
    <div style="display:flex; justify-content: flex-end; gap: 15px;">
        <button class="header-icon-btn" onclick="openOverlay('tap-overlay')">üñêÔ∏è</button>
        <button class="header-icon-btn" onclick="openOverlay('library-overlay')">?</button>
    </div>
</div>

<div id="monitor">
    <div id="song-info">
        <div id="song-title">Warte auf Musik...</div>
        <div id="ai-details">
            <span class="detail-badge" id="badge-bpm">--- BPM</span>
            <span class="detail-badge" id="badge-takt">--- TAKT</span>
            <span class="detail-badge" id="badge-rhythm">---</span>
        </div>
    </div>

    <div class="dance-wrap">
        <h1 id="dance-name">BEREIT</h1>
    </div>

    <div class="status-indicators">
        <div class="stat-box">
            <div id="bpm-display" class="stat-val">0</div>
            <div class="stat-label">BPM LIVE</div>
        </div>
        <div class="stat-box">
             <div id="conf-display" class="stat-val" style="font-size: 1.5rem; margin-bottom: 10px;">--</div>
            <div class="stat-label">ERKENNUNG</div>
        </div>
    </div>
</div>

<div id="settings-overlay" class="overlay">
    <div class="overlay-header">
        <h2 class="overlay-title">Einstellungen</h2>
        <button class="close-btn" onclick="closeOverlays()">‚úï</button>
    </div>
    
    <div class="settings-group">
        <div class="row"><label>OpenAI API Key</label></div>
        <input type="password" id="api-key" placeholder="sk-...">
        <div class="row" style="margin-top:10px;"><label>NTFY Topic (Shazam)</label></div>
        <input type="text" id="ntfy-topic" placeholder="Tanz_Das_DeinName">
        <button class="btn-action btn-save" onclick="saveSettings()">Speichern</button>
        <button class="btn-action btn-secondary" onclick="testAI()">KI Verbindung testen</button>
    </div>

    <div class="settings-group">
        <div class="row">
            <label>Datenbank Export/Import</label>
        </div>
        <div style="display:flex; gap:10px;">
            <button class="btn-action btn-secondary" onclick="exportData()">Export JSON</button>
            <button class="btn-action btn-secondary" onclick="document.getElementById('file-imp').click()">Import</button>
            <input type="file" id="file-imp" style="display:none" onchange="importData(this)">
        </div>
    </div>

    <div class="settings-group">
        <div class="row"><label>Verlauf</label></div>
        <input type="text" id="search-hist" placeholder="Suche..." oninput="renderHistory()">
        <div id="history-list" style="margin-top:15px;"></div>
    </div>
</div>

<div id="library-overlay" class="overlay">
    <div class="overlay-header">
        <h2 class="overlay-title">Videothek</h2>
        <button class="close-btn" onclick="closeOverlays()">‚úï</button>
    </div>
    <div id="library-content">
        </div>
</div>

<div id="fs-video-overlay" class="overlay">
    <div id="fs-video-container">
        <video id="main-video" playsinline></video>
        <div id="fs-controls">
            <button class="vid-btn" onclick="replayFigure()">‚Ü∫ Nochmal</button>
            <button class="vid-btn" onclick="closeOverlays(); document.getElementById('main-video').pause()">Schlie√üen</button>
        </div>
        <div id="vid-info" style="color:white; text-align:center; margin-top:10px; font-weight:bold;"></div>
    </div>
</div>

<div id="tap-overlay" class="overlay">
    <div class="overlay-header">
        <h2 class="overlay-title">Tap Detektor</h2>
        <button class="close-btn" onclick="closeOverlays()">‚úï</button>
    </div>
    <div style="text-align:center; color:#888; margin-bottom:20px;">
        Tippe den Takt (1-2-3-4) auf den Button.<br>Versuche den Rhythmus (Lang-Schnell) zu betonen.
    </div>
    <div id="tap-pad">
        <div class="tap-area" onpointerdown="handleTap(event)">TAP</div>
        <div id="tap-result">---</div>
        <div id="tap-bpm" style="font-family:monospace; font-size:1.5rem; color:#666;">0 BPM</div>
    </div>
    <button class="btn-action btn-secondary" onclick="resetTap()">Reset</button>
</div>

<script>
    // --- GLOBAL VARIABLES ---
    let audioCtx, analyser, micStream, isListening = false;
    let lastBeatTime = 0, bpmBuffer = [], localBpm = 0;
    let danceHistory = JSON.parse(localStorage.getItem('dm_history') || "[]");
    let currentAIResult = null; // Stores {bpm, dance, rhythm, takt}
    let calibrationOffset = 0; // Difference between Local and AI BPM
    let isCalibrated = false;

    // --- VIDEO LIBRARY DATA (from .vpj) ---
    // VPJ Logic: Clips are sequential in the file /media/chacha.mp4
    // We convert offsets and durations to seconds.
    const videoLibrary = {
        "Cha Cha Cha": {
            file: "media/chacha.mp4",
            figures: [
                { name: "1. Grundschritt am Platz / Timestep", start: 0.00, end: 17.55 },
                { name: "2. Grundschritt mit Wiegeschritt", start: 17.55, end: 30.48 },
                { name: "3. Damensolo", start: 30.48, end: 52.88 },
                { name: "4. New Yorker/Promenade", start: 52.88, end: 80.30 },
                { name: "5. Hand to Hand", start: 80.30, end: 103.50 },
                { name: "6. Shoulder to Shoulder", start: 103.50, end: 123.37 },
                { name: "7. Fan & Alemana", start: 123.37, end: 141.97 },
                { name: "8. Hockeystick & Open Hip Twist", start: 141.97, end: 169.44 },
                { name: "9. Aida", start: 169.44, end: 197.17 }
            ]
        },
        "Walzer": { file: "", figures: [] } // Platzhalter
    };

    // --- INIT ---
    window.onload = () => {
        document.getElementById('api-key').value = localStorage.getItem('dm_key') || "";
        document.getElementById('ntfy-topic').value = localStorage.getItem('dm_topic') || "";
        renderHistory();
        connectNtfy();
    };

    // --- OVERLAY HANDLING ---
    function openOverlay(id) {
        document.querySelectorAll('.overlay').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id === 'library-overlay') renderLibrary();
    }
    function closeOverlays() {
        document.querySelectorAll('.overlay').forEach(el => el.classList.remove('active'));
        const v = document.getElementById('main-video');
        if(!v.paused) v.pause();
    }

    // --- AUDIO & BEAT DETECTION ---
    async function toggleMic() {
        const btn = document.getElementById('mic-btn');
        if (isListening) {
            location.reload(); // Hard reset to clear audio context
        } else {
            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const source = audioCtx.createMediaStreamSource(micStream);
                
                // Lowpass Filter to isolate Bass/Kick
                const filter = audioCtx.createBiquadFilter();
                filter.type = "lowpass";
                filter.frequency.value = 150; 

                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 2048;
                
                source.connect(filter);
                filter.connect(analyser);

                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);

                isListening = true;
                btn.innerText = "STOP";
                btn.classList.add('active');
                
                if(isCalibrated) btn.classList.add('calibrated');

                const processAudio = () => {
                    if (!isListening) return;
                    requestAnimationFrame(processAudio);
                    analyser.getByteFrequencyData(dataArray);

                    // Simple Peak Detection
                    let maxVol = 0;
                    for(let i = 0; i < bufferLength; i++) { if(dataArray[i] > maxVol) maxVol = dataArray[i]; }

                    // Dynamic Threshold based on environment volume
                    const threshold = 180; // Hardcoded for now, could be dynamic
                    
                    if (maxVol > threshold) {
                        const now = Date.now();
                        // Debounce (max 200 BPM = 300ms)
                        if (now - lastBeatTime > 300) {
                            handleBeat(now);
                        }
                    }
                };
                processAudio();

            } catch (err) {
                alert("Mikrofon Zugriff verweigert oder Fehler: " + err);
            }
        }
    }

    function handleBeat(now) {
        // Visual Pulse
        document.getElementById('bpm-display').classList.remove('disco-beat');
        void document.getElementById('bpm-display').offsetWidth; // Trigger reflow
        document.getElementById('bpm-display').classList.add('disco-beat');

        if (lastBeatTime > 0) {
            const delta = now - lastBeatTime;
            let instBpm = Math.round(60000 / delta);

            // Sanity Check (Tanzen ist meist zwischen 60 und 200)
            if(instBpm < 50) instBpm *= 2; 
            if(instBpm > 220) instBpm /= 2;

            bpmBuffer.push(instBpm);
            if (bpmBuffer.length > 10) bpmBuffer.shift(); // Rolling average of last 10 beats

            // Berechne Durchschnitt
            localBpm = Math.round(bpmBuffer.reduce((a, b) => a + b, 0) / bpmBuffer.length);
            
            // Anzeige Update
            document.getElementById('bpm-display').innerText = localBpm;

            // Logik: Welcher Tanz? (LOKAL fallback, falls keine KI)
            if(!currentAIResult) {
                const guess = predictLocalDance(localBpm);
                document.getElementById('dance-name').innerText = guess;
                document.getElementById('dance-name').classList.remove('verified');
                document.getElementById('conf-display').innerText = "RAW";
            } else {
                // KALIBRIERTER MODUS
                document.getElementById('dance-name').innerText = currentAIResult.dance;
                document.getElementById('dance-name').classList.add('verified');
                
                // Zeige Abweichung an
                const diff = localBpm - parseInt(currentAIResult.bpm);
                const confEl = document.getElementById('conf-display');
                if(Math.abs(diff) < 5) {
                    confEl.innerText = "SYNC";
                    confEl.style.color = "var(--green)";
                } else {
                    confEl.innerText = (diff > 0 ? "+" : "") + diff;
                    confEl.style.color = "var(--red)";
                }
            }
        }
        lastBeatTime = now;
    }

    function predictLocalDance(bpm) {
        // Simple fallback rules based on infographic logic
        if (bpm >= 170) return "WIENER WALZER?";
        if (bpm >= 160) return "JIVE?";
        if (bpm >= 120 && bpm <= 132) return "CHA CHA / DISCOFOX?";
        if (bpm >= 100 && bpm < 120) return "RUMBA / SAMBA?";
        if (bpm >= 80 && bpm < 95) return "LANGS. WALZER?";
        if (bpm >= 60 && bpm < 70) return "TANGO?";
        return "H√ñRE ZU...";
    }

    // --- AI INTEGRATION & NTFY ---
    function connectNtfy() {
        const topic = localStorage.getItem('dm_topic');
        if(!topic) return;
        
        // Simuliere Ntfy Listener (Polling oder SSE)
        const eventSource = new EventSource(`https://ntfy.sh/${topic}/sse`);
        eventSource.onmessage = (e) => {
            const data = JSON.parse(e.data);
            if(data.message) {
                // Wir nehmen an, message ist der Songtitel (von Shazam Shortcut)
                handleNewSong(data.message);
                // Notification auch anzeigen
                const t = document.getElementById('song-title');
                t.innerText = data.message;
                t.style.opacity = 1;
            }
        };
    }

    async function handleNewSong(title) {
        const apiKey = document.getElementById('api-key').value;
        if(!apiKey) return;

        // UI Reset
        document.getElementById('song-title').innerText = title;
        document.getElementById('song-title').style.opacity = 1;
        document.getElementById('dance-name').innerText = "ANALYSE...";
        document.getElementById('ai-details').style.opacity = 0;

        // System Prompt basierend auf deiner Infografik
        const systemPrompt = `
Du bist ein professioneller Tanzlehrer. Analysiere den Songtitel.
Nutze folgendes Regelwerk f√ºr die Zuweisung (Priorit√§t: Takt -> BPM -> Rhythmus):
1. TAKTART:
   - 3/4: Langsamer Walzer (ca 84-90 BPM), Wiener Walzer (ca 174-180 BPM).
   - 4/4: Discofox, Cha Cha Cha, Rumba, Jive, Salsa, Foxtrott.
   - 2/4: Samba, Tango Argentino.
2. TEMPO (BPM):
   - Tango: ~60-66 BPM (Staccato).
   - Langsamer Walzer: ~84-90 BPM.
   - Rumba: ~100-108 BPM (Slow).
   - Samba: ~100-104 BPM (Bounce).
   - Cha Cha Cha: ~120-128 BPM (Distinct 4-&-1).
   - Discofox: ~120-128 BPM (Steady Beat).
   - Jive: ~168-176 BPM.
   - Wiener Walzer: ~174-180 BPM.
3. RHYTHMUS:
   - Walzer: 1-2-3.
   - ChaCha: 2-3-4-&-1.
   - Rumba: Slow-Quick-Quick.

Antworte NUR als JSON: {"dance": "Name", "bpm": number, "takt": "4/4", "rhythm": "kurz"}
`;

        try {
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: "gpt-4o-mini",
                    messages: [
                        { role: "system", content: systemPrompt },
                        { role: "user", content: `Song: ${title}` }
                    ],
                    max_tokens: 60
                })
            });
            const data = await response.json();
            const content = data.choices[0].message.content.replace(/```json/g, '').replace(/```/g, '').trim();
            const result = JSON.parse(content);

            // Update Global State
            currentAIResult = result;
            isCalibrated = true;
            if(isListening) document.getElementById('mic-btn').classList.add('calibrated');

            // UI Updates
            document.getElementById('dance-name').innerText = result.dance;
            document.getElementById('dance-name').classList.add('verified');
            
            document.getElementById('badge-bpm').innerText = result.bpm + " BPM";
            document.getElementById('badge-takt').innerText = result.takt;
            document.getElementById('badge-rhythm').innerText = result.rhythm || "Standard";
            document.getElementById('ai-details').style.opacity = 1;

            // Save to History
            addToHistory(title, result);

        } catch (e) {
            console.error(e);
            document.getElementById('dance-name').innerText = "KI FEHLER";
        }
    }

    function testAI() {
        handleNewSong("Ed Sheeran - Perfect"); // Test Case
    }

    // --- HISTORY DATABASE ---
    function addToHistory(title, data) {
        const entry = {
            id: Date.now(),
            date: new Date().toLocaleDateString('de-DE'),
            title: title,
            dance: data.dance,
            bpm: data.bpm,
            takt: data.takt,
            rhythm: data.rhythm,
            stars: 0
        };
        danceHistory.unshift(entry);
        localStorage.setItem('dm_history', JSON.stringify(danceHistory));
        renderHistory();
    }

    function renderHistory() {
        const filter = document.getElementById('search-hist').value.toLowerCase();
        const container = document.getElementById('history-list');
        container.innerHTML = "";

        danceHistory.forEach((item, index) => {
            if(item.title.toLowerCase().includes(filter) || item.dance.toLowerCase().includes(filter)) {
                const div = document.createElement('div');
                div.className = 'hist-card';
                div.innerHTML = `
                    <div class="hist-top">
                        <span>${item.date}</span>
                        <span>${item.bpm} BPM | ${item.takt}</span>
                    </div>
                    <div class="hist-title">${item.title}</div>
                    <div class="hist-dance">${item.dance}</div>
                    <div class="hist-meta">Rhythmus: ${item.rhythm || '-'}</div>
                    <div class="hist-stars">
                        ${[1,2,3,4,5].map(s => `<span class="${s <= item.stars ? 'active' : ''}" onclick="rateSong(${index}, ${s})">‚òÖ</span>`).join('')}
                    </div>
                    <div class="hist-del" onclick="deleteHist(${index})">‚úï</div>
                `;
                container.appendChild(div);
            }
        });
    }

    function rateSong(index, stars) {
        danceHistory[index].stars = stars;
        localStorage.setItem('dm_history', JSON.stringify(danceHistory));
        renderHistory();
    }
    
    function deleteHist(index) {
        if(confirm("Eintrag l√∂schen?")) {
            danceHistory.splice(index, 1);
            localStorage.setItem('dm_history', JSON.stringify(danceHistory));
            renderHistory();
        }
    }

    function exportData() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(danceHistory));
        const anchor = document.createElement('a');
        anchor.setAttribute("href", dataStr);
        anchor.setAttribute("download", "tanz_db.json");
        document.body.appendChild(anchor);
        anchor.click();
        anchor.remove();
    }

    function importData(input) {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const d = JSON.parse(e.target.result);
                if(Array.isArray(d)) {
                    danceHistory = d;
                    localStorage.setItem('dm_history', JSON.stringify(danceHistory));
                    renderHistory();
                    alert("Import erfolgreich!");
                }
            } catch(x) { alert("Formatfehler!"); }
        };
        reader.readAsText(file);
    }

    function saveSettings() {
        localStorage.setItem('dm_key', document.getElementById('api-key').value.trim());
        localStorage.setItem('dm_topic', document.getElementById('ntfy-topic').value.trim());
        location.reload();
    }

    // --- VIDEO LIBRARY LOGIC ---
    function renderLibrary() {
        const c = document.getElementById('library-content');
        c.innerHTML = '<div class="dance-grid"></div>';
        const grid = c.querySelector('.dance-grid');

        // Level 1: Dances
        Object.keys(videoLibrary).forEach(dance => {
            const card = document.createElement('div');
            card.className = 'dance-card';
            card.innerHTML = `<h3>${dance}</h3>`;
            card.onclick = () => showFigures(dance);
            grid.appendChild(card);
        });
    }

    function showFigures(dance) {
        const data = videoLibrary[dance];
        if(!data.file) return alert("Kein Video f√ºr diesen Tanz hinterlegt.");
        
        const c = document.getElementById('library-content');
        let html = `<button class="btn-action btn-secondary" style="margin-bottom:15px;" onclick="renderLibrary()">‚Üê Zur√ºck</button>`;
        html += `<div class="figure-list">`;
        data.figures.forEach((fig, idx) => {
            html += `
            <div class="figure-item" onclick="playVideoSection('${data.file}', ${fig.start}, ${fig.end}, '${fig.name}')">
                <span>${fig.name}</span>
                <span class="figure-play">‚ñ∂</span>
            </div>`;
        });
        html += `</div>`;
        c.innerHTML = html;
    }

    let currentVideoEnd = 0;
    let currentVideoStart = 0;

    function playVideoSection(src, start, end, title) {
        const overlay = document.getElementById('fs-video-overlay');
        const vid = document.getElementById('main-video');
        const info = document.getElementById('vid-info');

        overlay.classList.add('active');
        vid.src = src;
        vid.currentTime = start;
        currentVideoStart = start;
        currentVideoEnd = end;
        info.innerText = title;

        vid.play();

        // Stop at end
        vid.ontimeupdate = () => {
            if(vid.currentTime >= currentVideoEnd) {
                vid.pause();
                vid.currentTime = currentVideoEnd; // snap to end
            }
        };
    }

    function replayFigure() {
        const vid = document.getElementById('main-video');
        vid.currentTime = currentVideoStart;
        vid.play();
    }

    // --- TAP DETECTOR LOGIC ---
    let tapTimes = [];
    function handleTap(e) {
        e.preventDefault(); // prevent zoom
        const now = Date.now();
        const el = e.target;
        
        // Visual Feedback
        el.style.transform = "scale(0.9)";
        setTimeout(() => el.style.transform = "scale(1)", 100);

        if(tapTimes.length > 0 && (now - tapTimes[tapTimes.length-1]) > 2000) {
            tapTimes = []; // Reset if too long pause
        }
        
        tapTimes.push(now);
        if(tapTimes.length > 8) tapTimes.shift();

        if(tapTimes.length >= 2) {
            // Calc Intervals
            let intervals = [];
            for(let i=1; i<tapTimes.length; i++) {
                intervals.push(tapTimes[i] - tapTimes[i-1]);
            }
            
            // Avg BPM
            const avgMs = intervals.reduce((a,b)=>a+b)/intervals.length;
            const bpm = Math.round(60000/avgMs);
            document.getElementById('tap-bpm').innerText = bpm + " BPM";

            // Determine Rhythm/Dance (Simple Heuristics)
            let res = "Unklar";
            if(bpm > 160) res = "Wiener Walzer / Jive";
            else if(bpm > 115) res = "Cha Cha / Discofox";
            else if(bpm > 95) res = "Rumba / Samba";
            else if(bpm > 80) res = "Langsamer Walzer";
            else if(bpm > 50) res = "Tango";

            document.getElementById('tap-result').innerText = res;
        }
    }
    function resetTap() { tapTimes = []; document.getElementById('tap-bpm').innerText = "0 BPM"; document.getElementById('tap-result').innerText = "---"; }

</script>
</body>
</html>