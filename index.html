<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Tanz das! Ultimate</title>
    <style>
        :root { --blue: #2b7cff; --red: #FF3B30; --green: #34C759; --yellow: #FFCC00; --bg: #050505; --card: #15161a; --text: #e8e8e8; }
        
        * { box-sizing: border-box; touch-action: manipulation; user-select: none; -webkit-user-select: none; }
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; background: var(--bg); color: var(--text); font-family: system-ui, -apple-system, sans-serif; }
        body { display: flex; flex-direction: column; }
        
        /* --- HEADER --- */
        #top-bar { display: grid; grid-template-columns: 60px 1fr 80px; align-items: center; padding: 10px 15px; background: rgba(0,0,0,0.9); border-bottom: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(15px); z-index: 100; flex-shrink: 0; }
        .header-icon-btn { background: none; border: none; font-size: 1.6rem; cursor: pointer; color: var(--text); padding: 5px; }
        #mic-btn { background: #222; border: 2px solid #333; color: white; padding: 10px 10px; border-radius: 12px; font-weight: 900; font-size: 0.9rem; cursor: pointer; justify-self: center; width: 100px; transition: 0.3s; }
        #mic-btn.active { background: var(--green); border-color: var(--green); box-shadow: 0 0 15px rgba(52, 199, 89, 0.4); }
        #mic-btn.ai-mode { background: var(--blue); border-color: var(--blue); box-shadow: 0 0 15px rgba(43, 124, 255, 0.4); }

        /* --- MONITOR BEREICH --- */
        #monitor { flex: 1; display: flex; position: relative; width: 100%; overflow: hidden; }
        
        /* Linker Hauptbereich */
        #main-display { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: space-evenly; padding: 10px; z-index: 2; width: 100%; }

        #song-info { width: 100%; min-height: 70px; display: flex; flex-direction: column; align-items: center; justify-content: center; margin-bottom: 5px; transition: opacity 0.5s; opacity: 0; }
        #song-title { font-size: 1.3rem; color: var(--yellow); font-weight: 800; text-shadow: 0 0 10px rgba(255,204,0,0.3); max-width: 90%; text-overflow: ellipsis; overflow: hidden; white-space: nowrap; }
        #song-artist { font-size: 0.9rem; color: #aaa; margin-top: 2px; }
        #ai-details { font-size: 0.8rem; color: #aaa; margin-top: 5px; display: flex; gap: 5px; }
        .detail-badge { background: #333; padding: 2px 6px; border-radius: 4px; border: 1px solid #444; }

        .dance-wrap { position: relative; width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; flex: 1; min-height: 150px; }
        #dance-name { 
            font-size: clamp(2.5rem, 12vw, 5rem); 
            font-weight: 900; 
            text-transform: uppercase; 
            margin: 0; 
            line-height: 0.9; 
            color: #fff; 
            transition: color 0.3s, transform 0.2s; 
            text-align: center;
        }
        #dance-name.verified { color: var(--green); text-shadow: 0 0 20px rgba(52, 199, 89, 0.5); }
        .pulse-effect { transform: scale(1.05); text-shadow: 0 0 15px rgba(255,255,255,0.4); }

        .status-indicators { display: flex; gap: 20px; margin-top: 10px; align-items: flex-end; margin-bottom: 20px; }
        .stat-box { display: flex; flex-direction: column; align-items: center; }
        .stat-val { font-size: 2.5rem; font-weight: 900; font-family: monospace; color: #666; line-height: 1; }
        .stat-label { font-size: 0.7rem; letter-spacing: 2px; font-weight: bold; color: #555; margin-top: 5px; }

        /* Rechter Regler Bereich */
        #slider-sidebar { width: 60px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-left: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.3); padding: 10px 0; z-index: 10; flex-shrink: 0; }
        .slider-wrap { flex: 1; position: relative; width: 100%; display: flex; justify-content: center; }
        
        /* Vertikaler Slider Hack */
        input[type=range].vertical {
            writing-mode: bt-lr; /* IE */
            -webkit-appearance: slider-vertical; /* Webkit */
            width: 8px;
            height: 100%;
            outline: none;
            background: #333;
            border-radius: 4px;
            cursor: pointer;
        }
        /* Level Meter Hintergrund */
        #level-meter {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: rgba(52, 199, 89, 0.2);
            height: 0%;
            transition: height 0.05s;
            pointer-events: none;
            width: 100%;
            z-index: -1;
        }
        #sens-val-display { font-family: monospace; font-size: 0.8rem; margin-top: 10px; color: var(--blue); font-weight: bold; }

        /* --- OVERLAYS --- */
        .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000; flex-direction: column; padding: 20px; overflow-y: auto; }
        .overlay.active { display: flex; }
        .overlay-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-shrink: 0; }
        .overlay-title { font-size: 1.5rem; font-weight: 800; color: var(--blue); margin: 0; }
        .close-btn { background: #333; border: none; color: white; width: 35px; height: 35px; border-radius: 50%; font-weight: bold; cursor: pointer; }

        /* Settings CSS */
        .settings-group { background: var(--card); border-radius: 20px; padding: 20px; margin-bottom: 20px; border: 1px solid #333; }
        .row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 8px; }
        .row:last-child { border-bottom: none; margin-bottom: 0; }
        input[type="text"], input[type="password"], input[type="number"] { background: #000; border: 1px solid #444; color: white; padding: 10px; border-radius: 8px; width: 100%; margin-top: 5px; user-select: text; -webkit-user-select: text; }
        
        /* Slider Horizontal */
        input[type="range"].horizontal { -webkit-appearance: none; width: 100%; height: 8px; background: #333; border-radius: 5px; outline: none; margin-top: 5px; }
        input[type="range"].horizontal::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 22px; height: 22px; background: var(--blue); border-radius: 50%; cursor: pointer; }
        
        input[type="checkbox"] { transform: scale(1.5); accent-color: var(--blue); }

        /* Preferred Dances Tags */
        #pref-list { display: flex; flex-wrap: wrap; gap: 8px; margin: 10px 0; }
        .tag { background: var(--blue); color: white; padding: 6px 12px; border-radius: 15px; font-size: 0.85rem; display: flex; align-items: center; }
        .tag span { margin-left: 8px; cursor: pointer; font-weight: bold; opacity: 0.7; }
        
        .btn-action { width: 100%; padding: 15px; border-radius: 12px; border: none; font-weight: 800; margin-top: 10px; cursor: pointer; font-size: 1rem; }
        .btn-save { background: var(--green); color: white; }
        .btn-secondary { background: #222; color: #fff; border: 1px solid #444; }

        /* Expert Table */
        .expert-row { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 10px; margin-bottom: 8px; align-items: center; font-size: 0.9rem; }
        .expert-row input { text-align: center; padding: 8px; }

        /* History Table */
        #history-box { background: #000; border-radius: 15px; padding: 10px; margin-top: 20px; border: 1px solid #222; max-height: 400px; overflow-y: auto; }
        .hist-header, .hist-row { display: grid; grid-template-columns: 80px 1.5fr 1.5fr 1fr 1fr 60px 30px; gap: 5px; align-items: center; padding: 8px; font-size: 0.8rem; }
        .hist-header { color: var(--blue); font-weight: bold; border-bottom: 1px solid #333; position: sticky; top: 0; background: #000; z-index: 10; }
        .hist-row { border-bottom: 1px solid #111; }
        .stars { cursor: pointer; letter-spacing: -2px; color: #333; font-size: 1rem; }
        .stars span.active { color: var(--yellow); }
        
        @media (max-width: 700px) {
            .hist-header, .hist-row { grid-template-columns: 1.5fr 1.5fr 1fr 60px 30px; }
            .hist-header div:nth-child(1), .hist-row div:nth-child(1),
            .hist-header div:nth-child(4), .hist-row div:nth-child(4) { display: none; }
        }

        /* Video Library CSS */
        .dance-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .dance-card { background: var(--card); padding: 15px; border-radius: 15px; text-align: center; border: 1px solid #333; cursor: pointer; transition: 0.2s; }
        .dance-card:active { transform: scale(0.95); background: var(--blue); border-color: var(--blue); }
        .figure-list { display: flex; flex-direction: column; gap: 10px; }
        .figure-item { background: #222; padding: 15px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border: 1px solid #333; }
        .figure-play { color: var(--green); font-size: 1.5rem; }

        /* Fullscreen Video Overlay */
        #fs-video-overlay { background: black; display: none; justify-content: center; align-items: center; padding: 0; z-index: 3000; }
        #fs-video-overlay.active { display: flex; }
        #fs-video-container { width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; padding-bottom: 30px; }
        #main-video { max-width: 100%; max-height: 85vh; width: auto; height: auto; object-fit: contain; }
        #fs-controls { margin-top: 20px; display: flex; gap: 20px; justify-content: center; width: 100%; }
        .vid-btn { background: rgba(255,255,255,0.15); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 30px; padding: 12px 25px; cursor: pointer; backdrop-filter: blur(5px); font-weight: bold; }

        /* Tap Detector */
        #tap-pad { flex: 1; display: flex; flex-direction: column; gap: 20px; align-items: center; justify-content: center; }
        .tap-area { width: 220px; height: 220px; background: radial-gradient(circle, #333 0%, #111 100%); border: 4px solid #444; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 4rem; transition: 0.1s; cursor: pointer; touch-action: manipulation; color: #666; }
        .tap-area:active { transform: scale(0.92); border-color: var(--blue); background: var(--blue); color: white; box-shadow: 0 0 30px var(--blue); }
    </style>
</head>
<body>

<div id="top-bar">
    <button class="header-icon-btn" onclick="openOverlay('settings-overlay')">‚öôÔ∏è</button>
    <button id="mic-btn" onclick="mainAction()">START</button>
    <div style="display:flex; justify-content: flex-end; gap: 15px;">
        <button class="header-icon-btn" onclick="openOverlay('tap-overlay')">üñêÔ∏è</button>
        <button class="header-icon-btn" onclick="openOverlay('library-overlay')">?</button>
    </div>
</div>

<div id="monitor">
    
    <div id="main-display">
        <div id="song-info">
            <div id="song-title">Warte auf Musik...</div>
            <div id="song-artist"></div>
            <div id="ai-details">
                <span class="detail-badge" id="badge-source">LOKAL</span>
                <span class="detail-badge" id="badge-rhythm"></span>
            </div>
        </div>

        <div class="dance-wrap">
            <h1 id="dance-name">BEREIT</h1>
        </div>

        <div class="status-indicators">
            <div class="stat-box">
                <div id="bpm-display" class="stat-val">0</div>
                <div class="stat-label">BPM LIVE</div>
            </div>
            <div class="stat-box">
                <div id="takt-display" class="stat-val" style="font-size: 1.5rem; margin-bottom: 10px;">--</div>
                <div class="stat-label">TAKT</div>
            </div>
        </div>
    </div>

    <div id="slider-sidebar">
        <div style="font-size:0.6rem; color:#888; margin-bottom:10px;">SENS</div>
        <div class="slider-wrap">
            <div id="level-meter"></div>
            <input type="range" class="vertical" id="main-sens" min="1" max="100" value="45" oninput="updateSens(this.value)">
        </div>
        <div id="sens-val-display">45</div>
    </div>
</div>

<div id="settings-overlay" class="overlay">
    <div class="overlay-header">
        <h2 class="overlay-title">Einstellungen</h2>
        <button class="close-btn" onclick="closeOverlays()">‚úï</button>
    </div>
    
    <div class="settings-group">
        <div class="row"><label>OpenAI API Key</label></div>
        <input type="password" id="api-key" placeholder="sk-...">
        
        <div class="row" style="margin-top:10px;"><label>NTFY Topic (Shazam)</label></div>
        <input type="text" id="ntfy-topic" placeholder="Tanz_Das_DeinName">
        
        <div class="row" style="margin-top:15px;">
            <label>Disco-Modus (Pulsieren)</label>
            <input type="checkbox" id="disco-mode">
        </div>

        <div class="row">
            <label>Video Ton aktivieren</label>
            <input type="checkbox" id="video-audio">
        </div>

        <div class="row">
            <label>Video Geschwindigkeit</label>
            <div style="width: 50%;">
                <input type="range" class="horizontal" id="video-speed" min="0.25" max="1.0" step="0.25" value="1.0" oninput="updateSpeedLabel(this.value)">
                <div id="speed-val" style="text-align:right; font-size:0.8rem; color:var(--blue);">1.0x</div>
            </div>
        </div>
        
        <button class="btn-action btn-secondary" style="margin-top:20px;" onclick="openOverlay('expert-overlay')">Experten-Einstellungen & BPM</button>
        <button class="btn-action btn-save" onclick="saveSettings()">Speichern</button>
    </div>

    <div class="settings-group">
        <div class="row"><label>Bevorzugte T√§nze</label></div>
        <div style="font-size:0.8rem; color:#888; margin-bottom:5px;">Werden bei √úbereinstimmung vorgezogen.</div>
        <div id="pref-list"></div>
        <div style="display:flex; gap:10px; margin-top:10px;">
            <input type="text" id="new-pref" placeholder="Neuer Tanz...">
            <button class="btn-save" style="width:auto; padding:0 20px;" onclick="addPref()">+</button>
        </div>
    </div>

    <div class="settings-group">
        <div class="row">
            <label>Datenbank (Lokal)</label>
            <input type="text" id="search-hist" placeholder="Suche..." style="width:40%;" oninput="renderHistory()">
        </div>
        <div style="text-align:right; font-size:0.7rem; color:#666; margin-bottom:5px;">KI wird nur gefragt, wenn Titel unbekannt.</div>
        
        <div id="history-box">
            <div class="hist-header">
                <div onclick="sortHist('date')">DATUM ‚Üï</div>
                <div onclick="sortHist('artist')">ARTIST ‚Üï</div>
                <div onclick="sortHist('title')">TITEL ‚Üï</div>
                <div onclick="sortHist('dance')">TANZ ‚Üï</div>
                <div onclick="sortHist('stars')">‚≠ê ‚Üï</div>
                <div></div>
            </div>
            <div id="history-list"></div>
        </div>
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button class="btn-action btn-secondary" onclick="exportData()">Export JSON</button>
            <button class="btn-action btn-secondary" onclick="document.getElementById('file-imp').click()">Import</button>
            <input type="file" id="file-imp" style="display:none" onchange="importData(this)">
        </div>
    </div>
</div>

<div id="expert-overlay" class="overlay">
    <div class="overlay-header">
        <h2 class="overlay-title">Experten-Parameter</h2>
        <button class="close-btn" onclick="openOverlay('settings-overlay')">‚Üê</button>
    </div>
    <div class="settings-group">
        <div style="margin-bottom:15px; text-align:right;">
             <button class="btn-action btn-secondary" onclick="resetExpert()" style="font-size:0.8rem;">Auf Standard zur√ºcksetzen</button>
        </div>
        <div class="expert-row" style="color:#888; border-bottom:1px solid #333; padding-bottom:5px;">
            <span>Tanz</span><span>Min BPM</span><span>Max BPM</span>
        </div>
        <div id="expert-list"></div>
        <button class="btn-action btn-save" onclick="saveSettings()">Werte Speichern</button>
    </div>
</div>

<div id="library-overlay" class="overlay">
    <div class="overlay-header">
        <h2 class="overlay-title">Videothek</h2>
        <button class="close-btn" onclick="closeOverlays()">‚úï</button>
    </div>
    <div id="library-content"></div>
</div>

<div id="fs-video-overlay" class="overlay">
    <div id="fs-video-container">
        <video id="main-video" playsinline muted></video>
        <div id="fs-controls">
            <button class="vid-btn" onclick="replayFigure()">‚Ü∫ Nochmal</button>
            <button class="vid-btn" onclick="closeOverlays(); document.getElementById('main-video').pause()">Schlie√üen</button>
        </div>
        <div id="vid-info" style="color:white; text-align:center; margin-top:10px; font-weight:bold;"></div>
    </div>
</div>

<div id="tap-overlay" class="overlay">
    <div class="overlay-header">
        <h2 class="overlay-title">Tap Detektor</h2>
        <button class="close-btn" onclick="closeOverlays()">‚úï</button>
    </div>
    <div style="text-align:center; color:#888; margin-bottom:20px;">
        Tippe im Takt auf den Kreis.
    </div>
    <div id="tap-pad">
        <div class="tap-area" onpointerdown="handleTap(event)">üñêÔ∏è</div>
        <div id="tap-result">---</div>
        <div id="tap-bpm" style="font-family:monospace; font-size:1.5rem; color:#666;">0 BPM</div>
    </div>
    <button class="btn-action btn-secondary" onclick="resetTap()">Reset</button>
</div>

<script>
    // --- STATE & CONFIG ---
    let audioCtx, analyser, processor, isListening = false;
    let lastBeat = 0, bpmBuffer = [], aiLocked = false;
    let micSens = 0.0045; 
    let discoEnabled = true;
    let playbackSpeed = 1.0;
    let videoSound = false;
    
    let preferredDances = ["Walzer", "Rumba", "Cha Cha Cha", "Discofox", "Salsa", "Boogie", "Tango", "Foxtrott", "Quickstep"];
    let danceHistory = [];
    let sortKey = 'date', sortDir = -1;
    
    // Default Ranges
    const defaultRanges = {
        "Tango Argentino": { min: 55, max: 65, tact: "2/4", rhythm: "-" },
        "Langsamer Walzer": { min: 85, max: 95, tact: "3/4", rhythm: "1 2 3" },
        "Samba": { min: 100, max: 120, tact: "2/4", rhythm: "L e L" },
        "Rumba": { min: 100, max: 120, tact: "4/4", rhythm: "L S S" },
        "Discofox": { min: 100, max: 145, tact: "4/4", rhythm: "1 2 3" },
        "Cha Cha Cha": { min: 110, max: 135, tact: "4/4", rhythm: "1 2 3 4 +" },
        "Jive": { min: 130, max: 180, tact: "4/4", rhythm: "1 2 3 e 4" },
        "Wiener Walzer": { min: 135, max: 180, tact: "3/4", rhythm: "1 2 3" },
        "Boogie Woogie": { min: 140, max: 200, tact: "4/4", rhythm: "S S L L" },
        "Foxtrott": { min: 160, max: 200, tact: "4/4", rhythm: "L L S S" },
        "Salsa": { min: 160, max: 200, tact: "4/4", rhythm: "S S L S S L" }
    };
    let expertRanges = JSON.parse(JSON.stringify(defaultRanges));

    const videoLibrary = {
        "Cha Cha Cha": {
            file: "media/chacha.mp4",
            figures: [
                { name: "1. Grundschritt", start: 0.00, end: 17.55 },
                { name: "2. Wiegeschritt", start: 17.55, end: 30.48 },
                { name: "3. Damensolo", start: 30.48, end: 52.88 },
                { name: "4. New Yorker", start: 52.88, end: 80.30 },
                { name: "5. Hand to Hand", start: 80.30, end: 103.50 },
                { name: "6. Shoulder to Shoulder", start: 103.50, end: 123.37 },
                { name: "7. Fan & Alemana", start: 123.37, end: 141.97 },
                { name: "8. Hockeystick", start: 141.97, end: 169.44 },
                { name: "9. Aida", start: 169.44, end: 197.17 }
            ]
        },
        "Walzer": { file: "", figures: [] }
    };

    // --- INIT ---
    window.onload = () => {
        loadData();
        
        document.getElementById('api-key').value = localStorage.getItem('dm_key') || "";
        const topic = localStorage.getItem('dm_topic');
        if(topic) { document.getElementById('ntfy-topic').value = topic; connectNtfy(topic); }
        
        discoEnabled = localStorage.getItem('dm_disco') !== 'false';
        document.getElementById('disco-mode').checked = discoEnabled;

        videoSound = localStorage.getItem('dm_vid_sound') === 'true';
        document.getElementById('video-audio').checked = videoSound;

        playbackSpeed = parseFloat(localStorage.getItem('dm_speed')) || 1.0;
        document.getElementById('video-speed').value = playbackSpeed;
        updateSpeedLabel(playbackSpeed);

        const savedSens = localStorage.getItem('dm_sens') || 45;
        updateSens(savedSens);
        
        renderPrefs();
        renderHistory();
        renderExpert();
    };

    function loadData() {
        if(localStorage.getItem('dm_prefs')) preferredDances = JSON.parse(localStorage.getItem('dm_prefs'));
        if(localStorage.getItem('dm_history')) danceHistory = JSON.parse(localStorage.getItem('dm_history'));
        if(localStorage.getItem('dm_expert')) expertRanges = JSON.parse(localStorage.getItem('dm_expert'));
    }

    /* --- UI --- */
    function openOverlay(id) {
        document.querySelectorAll('.overlay').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id === 'library-overlay') renderLibrary();
    }
    function closeOverlays() {
        document.querySelectorAll('.overlay').forEach(el => el.classList.remove('active'));
        const v = document.getElementById('main-video');
        if(!v.paused) v.pause();
    }
    function updateSpeedLabel(val) {
        playbackSpeed = parseFloat(val);
        document.getElementById('speed-val').innerText = playbackSpeed + "x";
    }
    function saveSettings() {
        localStorage.setItem('dm_key', document.getElementById('api-key').value.trim());
        localStorage.setItem('dm_topic', document.getElementById('ntfy-topic').value.trim());
        localStorage.setItem('dm_disco', document.getElementById('disco-mode').checked);
        localStorage.setItem('dm_vid_sound', document.getElementById('video-audio').checked);
        localStorage.setItem('dm_speed', playbackSpeed);
        localStorage.setItem('dm_prefs', JSON.stringify(preferredDances));
        
        const inputs = document.querySelectorAll('.expert-input');
        inputs.forEach(inp => {
            const dance = inp.dataset.dance;
            const type = inp.dataset.type;
            if(expertRanges[dance]) expertRanges[dance][type] = parseInt(inp.value);
        });
        localStorage.setItem('dm_expert', JSON.stringify(expertRanges));
        location.reload();
    }
    function updateSens(val) {
        document.getElementById('main-sens').value = val;
        document.getElementById('sens-val-display').innerText = val;
        micSens = val / 1000; 
        localStorage.setItem('dm_sens', val);
    }

    /* --- AUDIO / LOCAL --- */
    function mainAction() {
        const btn = document.getElementById('mic-btn');
        if(btn.innerText === "START") toggleMic();
        else {
            isListening = false;
            if(audioCtx) audioCtx.close();
            btn.innerText = "START";
            btn.classList.remove('active');
            document.getElementById('level-meter').style.height = "0%";
            bpmBuffer = []; lastBeat = 0; // Reset
        }
    }

    async function toggleMic() {
        try {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            
            // Resume Context (wichtig f√ºr iOS)
            if(audioCtx.state === 'suspended') await audioCtx.resume();
            
            const source = audioCtx.createMediaStreamSource(stream);
            analyser = audioCtx.createAnalyser();
            processor = audioCtx.createScriptProcessor(2048, 1, 1);
            
            source.connect(analyser);
            analyser.connect(processor);
            processor.connect(audioCtx.destination);

            isListening = true;
            document.getElementById('mic-btn').innerText = "STOP";
            document.getElementById('mic-btn').classList.add('active');

            processor.onaudioprocess = (e) => {
                if(!isListening) return;
                const data = e.inputBuffer.getChannelData(0);
                let sum = 0;
                for(let i=0; i<data.length; i++) sum += data[i]*data[i];
                const rms = Math.sqrt(sum/data.length);
                
                const level = Math.min(100, rms * 1000); 
                document.getElementById('level-meter').style.height = level + "%";

                if(rms > micSens) {
                    const now = Date.now();
                    if(now - lastBeat > 300) { 
                        processBeat(now);
                        lastBeat = now;
                        document.getElementById('level-meter').style.background = "rgba(52, 199, 89, 0.8)";
                        setTimeout(()=>document.getElementById('level-meter').style.background = "rgba(52, 199, 89, 0.2)", 100);
                    }
                }
            };
        } catch(e) { alert("Mikrofon Fehler (bitte erlauben): " + e); }
    }

    function processBeat(now) {
        if(lastBeat > 0 && !aiLocked) {
            if(discoEnabled) {
                const el = document.getElementById('dance-name');
                el.classList.remove('pulse-effect');
                void el.offsetWidth;
                el.classList.add('pulse-effect');
            }

            const bpm = Math.round(60000 / (now - lastBeat));
            bpmBuffer.push(bpm);
            if(bpmBuffer.length > 8) bpmBuffer.shift();
            
            const avgBpm = Math.round(bpmBuffer.reduce((a,b)=>a+b,0) / bpmBuffer.length);
            document.getElementById('bpm-val').innerText = avgBpm;
            
            detectDance(avgBpm);
        }
    }

    function detectDance(bpm) {
        let matches = [];
        for(const [dance, range] of Object.entries(expertRanges)) {
            if(bpm >= range.min && bpm <= range.max) {
                matches.push({ name: dance, tact: range.tact, rhythm: range.rhythm });
            }
        }
        if(matches.length === 0) {
            updateDisplay("---", "--", "", false);
            return;
        }
        const preferredMatches = matches.filter(m => preferredDances.some(p => m.name.toLowerCase().includes(p.toLowerCase())));
        let winner = preferredMatches.length > 0 ? preferredMatches[0] : matches[0];
        if(preferredMatches.length > 1) {
            const nonDisco = preferredMatches.find(m => !m.name.toLowerCase().includes("disco"));
            if(nonDisco) winner = nonDisco;
        }
        updateDisplay(winner.name, winner.tact, winner.rhythm, false);
    }

    function updateDisplay(dance, tact, rhythm, verified) {
        document.getElementById('dance-name').innerText = dance;
        document.getElementById('takt-display').innerText = tact;
        document.getElementById('badge-rhythm').innerText = rhythm;
        const m = document.getElementById('dance-name');
        if(verified) m.classList.add('verified'); else m.classList.remove('verified');
        document.getElementById('badge-source').innerText = verified ? "KI / DB" : "LOKAL";
    }

    /* --- CLOUD / AI --- */
    function connectNtfy(topic) {
        const es = new EventSource(`https://ntfy.sh/${topic}/sse`);
        es.onmessage = (e) => {
            const d = JSON.parse(e.data);
            if(d.message) handleExternalInput(d.message);
        };
    }
    
    // Robuster Parser f√ºr das "Doppelt-JSON" Problem
    function cleanTitle(input) {
        if(!input) return "";
        try {
            // Falls Input ein String ist, der wie JSON aussieht (z.B. "{\"message\":...}")
            if(typeof input === 'string' && (input.startsWith('{') || input.startsWith('"'))) {
                 const parsed = JSON.parse(input);
                 return cleanTitle(parsed); // Rekursion
            }
            // Falls Input ein Objekt ist
            if(typeof input === 'object') {
                if(input.body) return cleanTitle(input.body);
                if(input.message) return cleanTitle(input.message);
                if(input.title) return input.title;
            }
        } catch(e) {}
        // Wenn kein JSON mehr, ist es wohl der String
        return input;
    }

    function handleExternalInput(rawStr) {
        let clean = cleanTitle(rawStr);
        if(!clean || typeof clean !== 'string' || clean.includes("Test")) return;
        
        let artist = "Unbekannt";
        let title = clean;
        if(clean.includes("-")) {
            const parts = clean.split("-");
            artist = parts[0].trim();
            title = parts.slice(1).join("-").trim();
        }

        document.getElementById('song-title').innerText = title;
        document.getElementById('song-artist').innerText = artist;
        document.getElementById('song-info').style.opacity = 1;

        const cached = danceHistory.find(x => x.title.toLowerCase().trim() === title.toLowerCase().trim());

        aiLocked = true;
        if(isListening) mainAction(); 
        
        if(cached) {
            updateDisplay(cached.dance, cached.tact || "4/4", cached.rhythm || "-", true);
            document.getElementById('bpm-val').innerText = cached.bpm || "DB";
            document.getElementById('badge-source').innerText = "DB";
        } else {
            askAI(artist, title);
        }
    }

    async function askAI(artist, title) {
        const key = document.getElementById('api-key').value;
        if(!key) return;

        updateDisplay("KI DENKT...", "", "", false);
        document.getElementById('mic-btn').classList.add('ai-mode');

        try {
            const prompt = `Song: "${title}" by "${artist}".
            Pick best dance style from this list (priority): ${preferredDances.join(", ")}.
            Return JSON: {"dance": "Name", "bpm": number, "tact": "4/4", "rhythm": "string"}`;

            const res = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
                body: JSON.stringify({
                    model: "gpt-4o-mini",
                    messages: [{ role: "user", content: prompt }],
                    max_tokens: 60
                })
            });
            
            const data = await res.json();
            const content = data.choices[0].message.content.replace(/```json/g, '').replace(/```/g, '').trim();
            const result = JSON.parse(content);

            danceHistory.unshift({
                date: new Date().toLocaleDateString('de-DE'),
                title: title,
                artist: artist,
                dance: result.dance,
                bpm: result.bpm,
                tact: result.tact,
                rhythm: result.rhythm,
                stars: 0
            });
            localStorage.setItem('dm_history', JSON.stringify(danceHistory));
            renderHistory();
            
            updateDisplay(result.dance, result.tact, result.rhythm, true);
            document.getElementById('bpm-val').innerText = result.bpm;

        } catch(e) {
            console.error(e);
            updateDisplay("FEHLER", "--", "", false);
        }
        
        setTimeout(() => {
            document.getElementById('mic-btn').classList.remove('ai-mode');
            aiLocked = false;
        }, 30000); 
    }

    /* --- HELPERS --- */
    function renderPrefs() {
        const list = document.getElementById('pref-list');
        list.innerHTML = preferredDances.map((d,i) => 
            `<div class="tag">${d}<span onclick="preferredDances.splice(${i},1);renderPrefs()">‚úï</span></div>`
        ).join('');
    }
    function addPref() {
        const v = document.getElementById('new-pref').value.trim();
        if(v && !preferredDances.includes(v)) {
            preferredDances.push(v);
            document.getElementById('new-pref').value = "";
            renderPrefs();
        }
    }
    function renderHistory() {
        const f = document.getElementById('search-hist').value.toLowerCase();
        const list = document.getElementById('history-list');
        let filtered = danceHistory.filter(h => h.title.toLowerCase().includes(f) || (h.artist && h.artist.toLowerCase().includes(f)) || h.dance.toLowerCase().includes(f));

        filtered.sort((a,b) => {
            let va = a[sortKey] || '', vb = b[sortKey] || '';
            if(sortKey === 'date') { va = va.split('.').reverse().join(''); vb = vb.split('.').reverse().join(''); }
            if(va < vb) return -1 * sortDir; if(va > vb) return 1 * sortDir; return 0;
        });

        list.innerHTML = filtered.map(h => {
            const idx = danceHistory.indexOf(h);
            return `
            <div class="hist-row">
                <div>${h.date}</div>
                <div>${h.artist || '-'}</div>
                <div style="font-weight:bold; color:white;">${h.title}</div>
                <div style="color:var(--blue);">${h.dance}</div>
                <div class="stars">${renderStars(idx, h.stars)}</div>
                <div onclick="delHist(${idx})" style="color:var(--red); cursor:pointer; font-weight:bold; text-align:center;">‚úï</div>
            </div>`;
        }).join('');
    }
    function renderStars(idx, n) { let s = ""; for(let i=1; i<=5; i++) s += `<span class="${i<=n?'active':''}" onclick="setStar(${idx},${i})">‚òÖ</span>`; return s; }
    function setStar(idx, n) { danceHistory[idx].stars = n; localStorage.setItem('dm_history', JSON.stringify(danceHistory)); renderHistory(); }
    function delHist(idx) { if(confirm("L√∂schen?")) { danceHistory.splice(idx,1); localStorage.setItem('dm_history', JSON.stringify(danceHistory)); renderHistory(); } }
    function sortHist(k) { if(sortKey === k) sortDir *= -1; else { sortKey = k; sortDir = 1; } renderHistory(); }
    function exportData() {
        const a = document.createElement('a');
        a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(danceHistory));
        a.download = "tanz_db.json";
        document.body.appendChild(a); a.click(); a.remove();
    }
    function importData(input) {
        const r = new FileReader();
        r.onload = (e) => { try { danceHistory=JSON.parse(e.target.result); localStorage.setItem('dm_history', JSON.stringify(danceHistory)); renderHistory(); alert("Import OK!"); } catch(x){ alert("Fehler!"); } };
        r.readAsText(input.files[0]);
    }
    function renderExpert() {
        const el = document.getElementById('expert-list');
        el.innerHTML = Object.keys(expertRanges).map(d => `
            <div class="expert-row">
                <span>${d}</span>
                <input type="number" class="expert-input" data-dance="${d}" data-type="min" value="${expertRanges[d].min}">
                <input type="number" class="expert-input" data-dance="${d}" data-type="max" value="${expertRanges[d].max}">
            </div>
        `).join('');
    }
    function resetExpert() { if(confirm("Zur√ºcksetzen?")) { expertRanges = JSON.parse(JSON.stringify(defaultRanges)); renderExpert(); } }
    
    function renderLibrary() {
        const c = document.getElementById('library-content');
        c.innerHTML = '<div class="dance-grid"></div>';
        const grid = c.querySelector('.dance-grid');
        Object.keys(videoLibrary).forEach(dance => {
            const card = document.createElement('div');
            card.className = 'dance-card';
            card.innerHTML = `<h3>${dance}</h3>`;
            card.onclick = () => showFigures(dance);
            grid.appendChild(card);
        });
    }
    function showFigures(dance) {
        const data = videoLibrary[dance];
        if(!data.file) return alert("Kein Video vorhanden.");
        const c = document.getElementById('library-content');
        let html = `<button class="btn-action btn-secondary" style="margin-bottom:15px;" onclick="renderLibrary()">‚Üê Zur√ºck</button><div class="figure-list">`;
        data.figures.forEach(fig => {
            html += `<div class="figure-item" onclick="playVid('${data.file}', ${fig.start}, ${fig.end}, '${fig.name}')"><span>${fig.name}</span><span class="figure-play">‚ñ∂</span></div>`;
        });
        c.innerHTML = html + "</div>";
    }
    let curStart=0, curEnd=0;
    function playVid(src, s, e, t) {
        const o = document.getElementById('fs-video-overlay');
        const v = document.getElementById('main-video');
        o.classList.add('active');
        v.src = src; v.currentTime = s; curStart=s; curEnd=e;
        v.playbackRate = playbackSpeed;
        v.muted = !videoSound; 
        document.getElementById('vid-info').innerText = t;
        v.play();
        v.ontimeupdate = () => { if(v.currentTime >= curEnd) { v.pause(); v.currentTime=curEnd; } };
    }
    function replayFigure() { const v = document.getElementById('main-video'); v.currentTime = curStart; v.playbackRate = playbackSpeed; v.play(); }

    let tapTimes = [];
    function handleTap(e) {
        e.preventDefault();
        const now = Date.now();
        const el = e.target;
        el.style.transform = "scale(0.9)"; setTimeout(() => el.style.transform = "scale(1)", 100);
        if(tapTimes.length > 0 && (now - tapTimes[tapTimes.length-1]) > 2000) tapTimes = [];
        tapTimes.push(now);
        if(tapTimes.length > 8) tapTimes.shift();
        if(tapTimes.length >= 2) {
            let intervals = [];
            for(let i=1; i<tapTimes.length; i++) intervals.push(tapTimes[i] - tapTimes[i-1]);
            const avgMs = intervals.reduce((a,b)=>a+b)/intervals.length;
            const bpm = Math.round(60000/avgMs);
            document.getElementById('tap-bpm').innerText = bpm + " BPM";
            detectDance(bpm);
            document.getElementById('tap-result').innerText = document.getElementById('dance-name').innerText;
        }
    }
    function resetTap() { tapTimes = []; document.getElementById('tap-bpm').innerText = "0 BPM"; document.getElementById('tap-result').innerText = "---"; }
</script>
</body>
</html>
